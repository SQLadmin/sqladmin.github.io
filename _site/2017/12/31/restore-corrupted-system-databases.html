<!DOCTYPE html><html lang="en" ><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="/assets/css/syntax.css" rel="stylesheet"><title>How To Restore Corrupted System Databases | The Data Guy</title><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="How To Restore Corrupted System Databases" /><meta name="author" content="Bhuvanesh" /><meta property="og:locale" content="en_US" /><meta name="description" content="This post is for restore corrupted system databases on SQL Server including the master, model, and msdb databases. Recovered all system databases from backup file." /><meta property="og:description" content="This post is for restore corrupted system databases on SQL Server including the master, model, and msdb databases. Recovered all system databases from backup file." /><meta property="og:site_name" content="The Data Guy" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2017-12-31T13:55:03+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="How To Restore Corrupted System Databases" /><meta name="twitter:site" content="@bhuvithedataguy" /><meta name="twitter:creator" content="@https://twitter.com/BhuviTheDataGuy" /> <script type="application/ld+json"> {"dateModified":"2017-12-31T13:55:03+00:00","datePublished":"2017-12-31T13:55:03+00:00","url":"/2017/12/31/restore-corrupted-system-databases","mainEntityOfPage":{"@type":"WebPage","@id":"/2017/12/31/restore-corrupted-system-databases"},"@type":"BlogPosting","author":{"@type":"Person","name":"Bhuvanesh"},"description":"This post is for restore corrupted system databases on SQL Server including the master, model, and msdb databases. Recovered all system databases from backup file.","headline":"How To Restore Corrupted System Databases","@context":"https://schema.org"}</script><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.7;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}#share-bar{font-size:20px}#share-bar h4{margin-bottom:10px;font-weight:500}.share-button{margin:0px;margin-bottom:10px;margin-right:3px;border:1px solid #D3D6D2;padding:5px 10px 5px 10px}.share-button:hover{opacity:1;color:#ffffff}.fa-facebook-official{color:#3b5998}.fa-facebook-official:hover{background-color:#3b5998}.fa-twitter{color:#55acee}.fa-twitter:hover{background-color:#55acee}.fa-google-plus{color:#dd4b39}.fa-google-plus:hover{background-color:#dd4b39}.fa-pinterest-p{color:#cb2027}.fa-pinterest-p:hover{background-color:#cb2027}.fa-tumblr{color:#32506d}.fa-tumblr:hover{background-color:#32506d}.fa-reddit-alien{color:#ff4500}.fa-reddit-alien:hover{background-color:#ff4500}.fa-linkedin{color:#007bb5}.fa-linkedin:hover{background-color:#007bb5}.fa-envelope{color:#444444}.fa-envelope:hover{background-color:#444444}</style></head><body><main role="main"><header role="banner"><h1 class="logo">The Data Guy</h1><div class="page-author h-card p-author"><img src="/assets/circle-cropped.png" class="author-avatar u-photo" alt="Bhuvanesh"></div><nav role="navigation"><ul><li><a href="/" >Home</a></li><li><a href="/posts/" >Posts</a></li><li><a href="/categories/" >Categories</a></li><li><a href="/tags/" >Tags</a></li><li><a href="https://medium.com/@bhuvithedataguy" >Medium Blog</a></li><li><a href="/search" >Search Here</a></li></ul></nav></header><section class="post"><h2>How To Restore Corrupted System Databases</h2><p><img src="/assets/How-To-Restore-Corrupted-System-Databases.jpg" alt="How To Restore Corrupted System Databases" /></p><p>Today Dec 31, Sunday. Everybody waiting for the New Year. I’m also waiting for that and enjoying the last holiday of this year. But my SQL server doesn’t like the 2018 I guess  We have migrated our SQL Datawarehouse from Datacenter to AWS. We followed block level copying method which means sent entire Disks data to AWS then create volumes from that data. We kept data and logs on different disks.</p><p>During the migration, we have migrated the data volume first and then migrated log disk after 10hrs. In between the 10hrs, the log file has grown a bit and the LSN chain get changed. In the MDF file its showing different LSN. Once everything has been migrated the SQL server was unable to start. Then we found the data corruption on the Master, Model and msdb databases. And yes, you are right the holiday went to DR day. Here is the story I restore corrupted system databases.</p><p>Initially, I taught master DB has corrupted.</p><blockquote><p>ERROR message The log scan number (17:128:7) passed to log scan in database ‘master’ is not valid. This error may indicate data corruption or that the log file (.ldf) does not match the data file (.mdf). If this error occurred during replication, re-create the publication. Otherwise, restore from backup if the problem results in a failure during startup.</p></blockquote><p>I can’t able to start the SQL server without master DB, Even I can’t restore the master DB with starting the SQL Server. So here are the steps I followed to restore the master DB.</p><ol><li>Rebuild the Master DB from the scratch.</li><li>But unable to start SQL, because msdb and model databases are corrupted.</li><li>Again rebuild the master DB.</li><li>Moved the MSDB and model database’s Data files to the previous Location.</li><li>Restored the msdb and Model DB from the Backup.</li><li>Restored the Master Database</li></ol><h2 id="rebuild-the-master-database">Rebuild the Master Database:</h2><ul><li>Im using SQL Server 2012.</li><li>Go to this location.</li></ul><figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">C:\Program</span><span class="w"> </span><span class="nx">Files\Microsoft</span><span class="w"> </span><span class="nx">SQL</span><span class="w"> </span><span class="nx">Server\110\Setup</span><span class="w"> </span><span class="nx">Bootstrap\SQLServer2012</span></code></pre></figure><ul><li>Open the command prompt in this location.</li><li>Run this command to rebuild the master DB.</li></ul><figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="o">.</span><span class="nf">\Setup.exe</span><span class="w"> </span><span class="nx">/QUIET</span><span class="w"> </span><span class="nx">/ACTION</span><span class="o">=</span><span class="nf">REBUILDDATABASE</span><span class="w"> </span><span class="nx">/INSTANCENAME</span><span class="o">=</span><span class="nf">MSSQLSERVER</span><span class="w"> </span><span class="nx">/SAPWD</span><span class="o">=</span><span class="w"> </span><span class="nf">Sql</span><span class="err">@</span><span class="nx">123</span></code></pre></figure><p>Done. Now it’s a fresh database and the model and msdb are rebuild as new databases.</p><h2 id="move-the-master-database-files-to-the-previous-location">Move the master database files to the previous location:</h2><p>My previous data files located like below,</p><table><tbody><tr><td>master</td><td>Z:\DATA\SystemDB\master.mdf</td></tr><tr><td>masterlog</td><td>F:\Logs\SystemLog\mastlog.ldf</td></tr></tbody></table><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
<span class="k">GO</span>
<span class="k">ALTER</span>  <span class="k">DATABASE</span> <span class="n">master</span>
<span class="k">MODIFY</span> <span class="n">FILE</span> <span class="p">(</span><span class="n">NAME</span> <span class="o">=</span> <span class="n">master</span><span class="p">,</span> <span class="n">FILENAME</span> <span class="o">=</span> <span class="s1">'Z:</span><span class="se">\D</span><span class="s1">ATA</span><span class="se">\S</span><span class="s1">ystemDB</span><span class="se">\m</span><span class="s1">aster.mdf'</span><span class="p">);</span>
<span class="k">GO</span>
<span class="k">ALTER</span>  <span class="k">DATABASE</span> <span class="n">msdb</span>
<span class="k">MODIFY</span> <span class="n">FILE</span> <span class="p">(</span><span class="n">NAME</span> <span class="o">=</span> <span class="n">masterlog</span><span class="p">,</span> <span class="n">FILENAME</span> <span class="o">=</span> <span class="s1">'F:</span><span class="se">\l</span><span class="s1">OGS</span><span class="se">\S</span><span class="s1">YSTEMLOG</span><span class="se">\m</span><span class="s1">asterlog.ldf'</span><span class="p">);</span>
<span class="k">GO</span></code></pre></figure><ul><li>Stop SQL server.</li><li>Move the MDF and LDF files to the respective locations.</li><li>Start SQL Server.</li></ul><h2 id="restore-the-old-master-database-from-backup">Restore the Old master Database from Backup:</h2><ul><li>Stop SQL Server.</li><li>Start SQL server with Singler user mode.</li><li>Open Powershell and went to the below Directory.</li></ul><figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">C:\Program</span><span class="w"> </span><span class="nx">Files\Microsoft</span><span class="w"> </span><span class="nx">SQL</span><span class="w"> </span><span class="nx">Server\MSSQL11.MSSQLSERVER\MSSQL\Binn</span></code></pre></figure><ul><li>Run this command in Powershell</li></ul><figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="o">.</span><span class="nf">\sqlservr.exe</span><span class="w"> </span><span class="nt">-m</span></code></pre></figure><ul><li>Open a command prompt window.</li></ul><figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">sqlcmd</span><span class="w"> </span><span class="nt">-U</span><span class="w"> </span><span class="nx">sa</span><span class="w"> </span><span class="nt">-p</span><span class="w">
</span><span class="nf">Restore</span><span class="err"> </span><span class="nx">database</span><span class="err"> </span><span class="nx">master</span><span class="err"> </span><span class="nx">from</span><span class="err"> </span><span class="nx">disk</span><span class="err"> </span><span class="o">=</span><span class="s1">'O:\master_full.bak'</span><span class="err"> </span><span class="nf">with</span><span class="err"> </span><span class="nx">replace</span><span class="p">;</span><span class="w">
</span><span class="nf">GO</span></code></pre></figure><ul><li>Once it’s restored the SQL server will be automatically stopped.</li><li>Started SQL Server and the master database was completely recovered.</li></ul><h3 id="shocking-sql-server-wont-start-again-another-issue-with-model-andmsdbdatabases">Shocking!! SQL server won’t start again. Another issue with Model and <strong>msdb</strong> databases.</h3><blockquote><p>ERROR message The log scan number (17:132:14) passed to log scan in database ‘msdb’ is not valid. This error may indicate data corruption or that the log file (.ldf) does not match the data file (.mdf). If this error occurred during replication, re-create the publication. Otherwise, restore from backup if the problem results in a failure during startup.</p></blockquote><p>Again the same issue. Ok, then I decided to recover the MSDB and Model databases first.</p><h2 id="recover-msdb-and-model-databases">Recover MSDB and MODEL Databases:</h2><ul><li>Again I rebuild the Master database (followed the above steps)</li><li>Execute the below query to move the files to the different drive.</li><li>Stop SQL server and move the datafiles to the respective folders, then start the SQL Server.</li></ul><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">USE</span> <span class="n">master</span><span class="p">;</span>
<span class="k">GO</span>
<span class="k">ALTER</span> <span class="k">DATABASE</span> <span class="n">model</span><span class="p">;</span>
<span class="k">MODIFY</span> <span class="n">FILE</span> <span class="p">(</span><span class="n">NAME</span> <span class="o">=</span> <span class="n">model</span><span class="p">,</span> <span class="n">FILENAME</span> <span class="o">=</span> <span class="s1">'Z:</span><span class="se">\D</span><span class="s1">ATA</span><span class="se">\S</span><span class="s1">ystemDB</span><span class="se">\m</span><span class="s1">odel.mdf'</span><span class="p">);</span>
<span class="k">GO</span>
<span class="k">ALTER</span> <span class="k">DATABASE</span> <span class="n">msdb</span>
<span class="k">MODIFY</span> <span class="n">FILE</span> <span class="p">(</span><span class="n">NAME</span> <span class="o">=</span> <span class="n">modellog</span><span class="p">,</span> <span class="n">FILENAME</span> <span class="o">=</span> <span class="s1">'F:</span><span class="se">\l</span><span class="s1">OGS</span><span class="se">\S</span><span class="s1">YSTEMLOG</span><span class="se">\m</span><span class="s1">odellog.ldf'</span><span class="p">);</span>
<span class="k">GO</span>

<span class="k">ALTER</span> <span class="k">DATABASE</span> <span class="n">msdb</span><span class="p">;</span>
<span class="k">MODIFY</span> <span class="n">FILE</span> <span class="p">(</span><span class="n">NAME</span> <span class="o">=</span> <span class="n">MSDBData</span><span class="p">,</span> <span class="n">FILENAME</span> <span class="o">=</span> <span class="s1">'Z:</span><span class="se">\D</span><span class="s1">ATA</span><span class="se">\S</span><span class="s1">ystemDB</span><span class="se">\M</span><span class="s1">SDBData.mdf'</span><span class="p">);</span>
<span class="k">GO</span>
<span class="k">ALTER</span> <span class="k">DATABASE</span> <span class="n">msdb</span>
<span class="k">MODIFY</span> <span class="n">FILE</span> <span class="p">(</span><span class="n">NAME</span> <span class="o">=</span> <span class="n">MSDBlog</span><span class="p">,</span> <span class="n">FILENAME</span> <span class="o">=</span> <span class="s1">'F:</span><span class="se">\l</span><span class="s1">OGS</span><span class="se">\S</span><span class="s1">YSTEMLOG</span><span class="se">\M</span><span class="s1">SDBData.ldf'</span><span class="p">);</span>
<span class="k">GO</span></code></pre></figure><p>In SSMS,</p><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">Restore</span> <span class="k">database</span> <span class="n">model</span> <span class="k">from</span> <span class="n">disk</span> <span class="o">=</span><span class="s1">'O:</span><span class="se">\m</span><span class="s1">odel_full.bak'</span> <span class="k">with</span> <span class="k">replace</span><span class="p">;</span>
<span class="n">Restore</span> <span class="k">database</span> <span class="n">msdb</span> <span class="k">from</span> <span class="n">disk</span> <span class="o">=</span><span class="s1">'O:</span><span class="se">\m</span><span class="s1">sdb_full.bak'</span> <span class="k">with</span> <span class="k">replace</span><span class="p">;</span></code></pre></figure><p>Done!!</p><h2 id="restore-the-master-database">Restore the Master Database:</h2><p>Now restore the Master database from the backup file.</p><ul><li>Stop SQL Server.</li><li>Start with single User mode.</li><li>Restore the database using SQLCMD.</li></ul><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">Restore</span> <span class="k">database</span> <span class="n">master</span> <span class="k">from</span> <span class="n">disk</span> <span class="o">=</span><span class="s1">'O:</span><span class="se">\m</span><span class="s1">aster_full.bak'</span> <span class="k">with</span> <span class="k">replace</span><span class="p">;</span></code></pre></figure><p>Finally, I have recovered all the system databases. But few of the databases went to suspect mode, but its not biggest deal to fix them.</p><span class="meta"><time datetime="2017-12-31T13:55:03+00:00">December 31, 2017</time> &middot; <a href="/tags/#backup">backup</a>, <a href="/tags/#recovery">recovery</a>, <a href="/tags/#sqlserver">sqlserver</a></span><hr> <!--<span class="meta"><time datetime="2017-12-31T13:55:03+00:00">December 31, 2017</time> &middot; <a class="post" href="/tag/backup">backup</a>, <a class="post" href="/tag/recovery">recovery</a>, <a class="post" href="/tag/sqlserver">sqlserver</a></span> --></section></main></body></html>
