<!DOCTYPE html><html lang="en" ><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="/assets/css/syntax.css" rel="stylesheet"><title>Internals Of Google DataStore And Technical Overview | The Data Guy</title><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="Internals Of Google DataStore And Technical Overview" /><meta name="author" content="Bhuvanesh" /><meta property="og:locale" content="en_US" /><meta name="description" content="This article explains the overview of the Google Datastore and its internal workflow like bigtable, index and other things." /><meta property="og:description" content="This article explains the overview of the Google Datastore and its internal workflow like bigtable, index and other things." /><meta property="og:site_name" content="The Data Guy" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-09-10T20:00:54+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Internals Of Google DataStore And Technical Overview" /><meta name="twitter:site" content="@bhuvithedataguy" /><meta name="twitter:creator" content="@https://twitter.com/BhuviTheDataGuy" /> <script type="application/ld+json"> {"dateModified":"2018-09-10T20:00:54+00:00","datePublished":"2018-09-10T20:00:54+00:00","url":"/2018/09/10/internals-of-google-datastore-and-technical-overview","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/09/10/internals-of-google-datastore-and-technical-overview"},"@type":"BlogPosting","author":{"@type":"Person","name":"Bhuvanesh"},"description":"This article explains the overview of the Google Datastore and its internal workflow like bigtable, index and other things.","headline":"Internals Of Google DataStore And Technical Overview","@context":"https://schema.org"}</script><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.7;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}#share-bar{font-size:20px}#share-bar h4{margin-bottom:10px;font-weight:500}.share-button{margin:0px;margin-bottom:10px;margin-right:3px;border:1px solid #D3D6D2;padding:5px 10px 5px 10px}.share-button:hover{opacity:1;color:#ffffff}.fa-facebook-official{color:#3b5998}.fa-facebook-official:hover{background-color:#3b5998}.fa-twitter{color:#55acee}.fa-twitter:hover{background-color:#55acee}.fa-google-plus{color:#dd4b39}.fa-google-plus:hover{background-color:#dd4b39}.fa-pinterest-p{color:#cb2027}.fa-pinterest-p:hover{background-color:#cb2027}.fa-tumblr{color:#32506d}.fa-tumblr:hover{background-color:#32506d}.fa-reddit-alien{color:#ff4500}.fa-reddit-alien:hover{background-color:#ff4500}.fa-linkedin{color:#007bb5}.fa-linkedin:hover{background-color:#007bb5}.fa-envelope{color:#444444}.fa-envelope:hover{background-color:#444444}</style></head><body><main role="main"><header role="banner"><h1 class="logo">The Data Guy</h1><div class="page-author h-card p-author"><img src="/assets/circle-cropped.png" class="author-avatar u-photo" alt="Bhuvanesh"></div><nav role="navigation"><ul><li><a href="/" >Home</a></li><li><a href="/posts/" >Posts</a></li><li><a href="/categories/" >Categories</a></li><li><a href="/tags/" >Tags</a></li><li><a href="https://medium.com/@bhuvithedataguy" >Medium Blog</a></li><li><a href="/search" >Search Here</a></li></ul></nav></header><section class="post"><h2>Internals Of Google DataStore And Technical Overview</h2><p>Google Cloud Platform provides many varieties of solutions. In Data world particularly in NoSQL technology Google provides Datastore a highly scalable and availability solution with ACID capabilities. I have read a lot about the Google Datastore and its Internals. Here Im going to merge everything as a single blog post.</p><p><img src="/assets/Internals-Of-Google-DataStore-And-Technical-Overview.jpg" alt="Internals Of Google DataStore And Technical Overview" /></p><h2 id="what--why-datastore">What / Why Datastore? </h2><p>Google datastore is a NoSQL database service. It can scale to multi regions. We should use Datastore as a Transactional Database. We shouldn’t use this for an Analytical purpose instead use BigTable is for OLAP. </p><ul><li>No need to provision and manage the Infra.</li><li>No need for a DBA (performance, backup and restore, HA, Import and export).</li><li>Fully Managed Service. </li><li>ACID support.</li><li>Highly scalable to multiple regions with very less latency. </li><li>Highly Available.</li></ul><h2 id="relational-vs-datastore">Relational vs Datastore</h2><p><img src="/assets/Internals-Of-Google-DataStore-And-Technical-Overview_2.jpg" alt="Internals Of Google DataStore And Technical Overview" /></p><h2 id="internals-of-datastore">Internals of Datastore:</h2><p>The Datastore is build on top the Google BigTable. So before understanding the Datastore lets understand the concept of the BigTable.</p><h3 id="google-bigtable">Google BigTable:</h3><p>Google Bigtable is a not a complete database, its a Storage for the data. </p><ul><li>BigTable is Used by Google internally since 2005.</li><li>It’s a structured key-value storge.</li><li>Distributed Storage.</li><li>Highly available and scalable system.</li><li>It supports CRUD (Create, Read, Update and Delete).</li><li>BigTable only supports Range Scan.</li><li>A Row contains a Key and Column.</li><li>Data is sorted by Key (lexical order)</li></ul><p><img src="/assets/Internals-Of-Google-DataStore-And-Technical-Overview_3.jpg" alt="Internals Of Google DataStore And Technical Overview" /></p><p>Auto sharding (Credits: google Next)</p><h3 id="datastore">Datastore:</h3><p>All the BigTable capabilities are suitable for Datastore as well. Because Datastore is built on top of it. Google came up with a solution as Datastore to make the BigTable as a NoSQL Transactional Database. See the below image, all of these things are managed by Google. </p><p><img src="/assets/Internals-Of-Google-DataStore-And-Technical-Overview_1.jpg" alt="Internals Of Google DataStore And Technical Overview" /></p><p>Credit: Google Next</p><ol><li>Bigtable provides auto sharding during the heavy transactions and takes care of the data storage.</li><li>MegaStore Provides High availability and High consistency transactions with ACID.</li><li>And finally, Datastore bring the traditional NoSQL things.</li><li>Low Lock granularity improves the performance. </li></ol><p><img src="/assets/Internals-Of-Google-DataStore-And-Technical-Overview_4.jpg" alt="Internals Of Google DataStore And Technical Overview" /></p><p>Credit: Google Developers</p><h3 id="replication">Replication:</h3><p>Google Datastore supports Region and MultiRegional replication. Multi Region replication only supports in few regions based on the region you are selecting while create your first Datastore kind. Region replication will automatically copy the data to multiple nodes which are in the multiple datacenters. </p><p>Europe and North America regions are supporting Multi Region Replication. Rest of the regions are support single region replication.</p><p><img src="/assets/Internals-Of-Google-DataStore-And-Technical-Overview_5.jpg" alt="Internals Of Google DataStore And Technical Overview" /></p><p>The above diagram explains the multi replication replication. Each Regions are interconnected with three independent fiber optics network. Two regions have the complete replica of the data in two different data centers. And the remaining one is having the data in one region called as a witness will tie-break during any one of the region went fail. </p><h3 id="consistancy"> Consistancy:</h3><p>Datastore supports two consistency levels.</p><ul><li>Strong consistency</li><li>Eventual consistency</li></ul><h3 id="strong-consistency">Strong Consistency: </h3><p>In strong consistency, Parallel threads will work together to on all data centers and regions. Strong consistency will occur while accessing,</p><ul><li>Key-Value Operation</li><li>Entity Group (Ancestor query)</li></ul><p><strong>Example:</strong> Lets say you have user and orders table. In orders table, you are referring user_id column is common for both tables, means its a parent-child relationship (in Relational user_id id Primary key on the User table and in orders table its a foreign key). The table will look like below.</p><p><img src="/assets/Internals-Of-Google-DataStore-And-Technical-Overview_8.jpg" alt="Internals Of Google DataStore And Technical Overview" /></p><ul><li>Now we are going to Update the orders for the user_id X to 3.</li><li><p>Then multiple parallel threads will start to update this value on all the regions.</p></li><li>If someone trying to access the Order for the user_id X during this update, their sessions will be locked until the update complete on all the regions. </li><li>Refer the below Diagram for this process.</li></ul><p><img src="/assets/Internals-Of-Google-DataStore-And-Technical-Overview_6.jpg" alt="Internals Of Google DataStore And Technical Overview" /></p><p>Credit: Google Next</p><h3 id="eventual-consistency">Eventual Consistency: </h3><p>Eventual consistencies are compared to Dirty Reads in a Relational database. This types of consistencies will occur when you are dealing with Non-Ancestor queries. </p><p><strong>Example:</strong> Consider you have a kind which has only one property and it has only one value called X. Now you are going to delete the value X and insert two new values Y, Z.</p><ul><li><p>In this process, the queries are not touching any Ancestor.</p></li><li>So parallel thread will delete the data X on the Region 1.</li><li>Meantime, someone reads the data in the kind on Region 2.</li><li>Due to eventual consistency, the data will take a bit time to replicate to Another region, but other users can able to read the old data. </li><li>Refer the below Diagram.</li></ul><p><img src="/assets/Internals-Of-Google-DataStore-And-Technical-Overview_7.jpg" alt="Internals Of Google DataStore And Technical Overview" /></p><p>Credit: Google Next</p><h3 id="index">Index:</h3><p>Index is the another huge topic in Datastore. We already read that BigTable will do Range scans only. But Google Datastore can work same as the other NoSQL databases. So it should support exact values search. Here the indices are coming to the picture. </p><blockquote><p>In Datastore, Queries are executed on the Index scan.</p></blockquote><p>So, if you check statistics of your Datastore, the index size will be larger than the entities. In relational databases, we need index for improving the performance. But in Datastore indices are need to scan your data. If you are scanning the data on an unindexed property, the query will fail.</p><p>Datastore has two types of index.</p><ul><li>Single properly index – Index on one particular property. </li><li>Composite index – Index on multiple properties.</li></ul><p>Bigtable will also create another table for index. Lets explain this with an example. Remember, Bigtable will do Range scan. In the index table, its also having the key-Value things but values of the property as Keys. So the actual data is in the key. A range scan is fine to get your data.</p><h3 id="single-property-index">Single property index:</h3><blockquote><p>Single Property index is created automatically by Datastore.</p></blockquote><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">Select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">Person</span>
<span class="k">where</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="mi">72</span>
<span class="k">Order</span> <span class="k">by</span> <span class="n">height</span> <span class="k">DESC</span><span class="p">;</span></code></pre></figure><p>In Bigtable, the property as Key and data is Value.  So the Bigtable’s table will look like below and it’ll do a range scan on the KEY which is equal to the string height. </p><figure class="highlight"><pre><code class="language-shell" data-lang="shell">KEY   : VALUE
____________
name  : X
name  : Y
height: 71
height: 72
height: 73
height: 75
height: 80</code></pre></figure><p>The BigTable scan will return all the values. But we need &lt; 72. Here index table will work. In the index table, the Bigtable’s values are Key means <em>71,72,73,75,80</em> are the Keys for Index table. So while performing the range scan on the index table, we can get the data </p><p><strong>Another Visual Example of Index Scan:</strong></p><p><img src="/assets/Internals-Of-Google-DataStore-And-Technical-Overview_9.jpg" alt="Internals Of Google DataStore And Technical Overview" /></p><p>Credi: Google Developers</p><h3 id="composite-index">Composite Index: </h3><p>Composite index will work in the same way as Single property Index. It’ll help on filtering on multiple properties and Order by on multiple columns.</p><p><strong>Create composite Index:</strong></p><p>You can create composite index in a yaml file and use gcloud util to create it on the Datastore. The below yaml file will create the composite index on order_date and user_id properties.</p><figure class="highlight"><pre><code class="language-shell" data-lang="shell">indexes:
  kind: orders
  properties
  - name: order_date
  - name: user_id</code></pre></figure><p><strong>Visual Example:</strong></p><p><img src="/assets/Internals-Of-Google-DataStore-And-Technical-Overview_10.jpg" alt="Internals Of Google DataStore And Technical Overview" /></p><p>Credit: Google Devloper</p><h2 id="to-learn-more-about-the-query-execution-and-query-restrictions">To learn more about the Query Execution and Query Restrictions:</h2><div class="responsive-embed responsive-embed-16by9"> <iframe class="responsive-embed-item" src="https://www.youtube.com/embed/d4CiMWy0J70"></iframe></div><span class="meta"><time datetime="2018-09-10T20:00:54+00:00">September 10, 2018</time> &middot; <a href="/tags/#bigtable">bigtable</a>, <a href="/tags/#datastore">datastore</a>, <a href="/tags/#gcp">gcp</a>, <a href="/tags/#internals">internals</a></span><hr> <!--<span class="meta"><time datetime="2018-09-10T20:00:54+00:00">September 10, 2018</time> &middot; <a class="post" href="/tag/bigtable">bigtable</a>, <a class="post" href="/tag/datastore">datastore</a>, <a class="post" href="/tag/gcp">gcp</a>, <a class="post" href="/tag/internals">internals</a></span> --></section></main></body></html>
