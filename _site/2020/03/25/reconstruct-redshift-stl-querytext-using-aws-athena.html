<!DOCTYPE html><html lang="en" ><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="/assets/css/syntax.css" rel="stylesheet"><title>Reconstruct RedShift STL_QUERYTEXT using AWS Athena | The Data Guy</title><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="Reconstruct RedShift STL_QUERYTEXT using AWS Athena" /><meta name="author" content="Bhuvanesh" /><meta property="og:locale" content="en_US" /><meta name="description" content="Reconstruct all SQL queries from STL_QUERYTEXT with AWS Athena" /><meta property="og:description" content="Reconstruct all SQL queries from STL_QUERYTEXT with AWS Athena" /><meta property="og:site_name" content="The Data Guy" /><meta property="og:image" content="/assets/Reconstrcut%20RedShift%20STL_QUERYTEXT%20using%20AWS%20Athena-cover.jpg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-03-25T01:15:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:image" content="/assets/Reconstrcut%20RedShift%20STL_QUERYTEXT%20using%20AWS%20Athena-cover.jpg" /><meta property="twitter:title" content="Reconstruct RedShift STL_QUERYTEXT using AWS Athena" /><meta name="twitter:site" content="@bhuvithedataguy" /><meta name="twitter:creator" content="@https://twitter.com/BhuviTheDataGuy" /> <script type="application/ld+json"> {"dateModified":"2020-03-25T01:15:00+00:00","datePublished":"2020-03-25T01:15:00+00:00","image":"/assets/Reconstrcut%20RedShift%20STL_QUERYTEXT%20using%20AWS%20Athena-cover.jpg","url":"/2020/03/25/reconstruct-redshift-stl-querytext-using-aws-athena","mainEntityOfPage":{"@type":"WebPage","@id":"/2020/03/25/reconstruct-redshift-stl-querytext-using-aws-athena"},"@type":"BlogPosting","author":{"@type":"Person","name":"Bhuvanesh"},"description":"Reconstruct all SQL queries from STL_QUERYTEXT with AWS Athena","headline":"Reconstruct RedShift STL_QUERYTEXT using AWS Athena","@context":"https://schema.org"}</script><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.7;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}#share-bar{font-size:20px}#share-bar h4{margin-bottom:10px;font-weight:500}.share-button{margin:0px;margin-bottom:10px;margin-right:3px;border:1px solid #D3D6D2;padding:5px 10px 5px 10px}.share-button:hover{opacity:1;color:#ffffff}.fa-facebook-official{color:#3b5998}.fa-facebook-official:hover{background-color:#3b5998}.fa-twitter{color:#55acee}.fa-twitter:hover{background-color:#55acee}.fa-google-plus{color:#dd4b39}.fa-google-plus:hover{background-color:#dd4b39}.fa-pinterest-p{color:#cb2027}.fa-pinterest-p:hover{background-color:#cb2027}.fa-tumblr{color:#32506d}.fa-tumblr:hover{background-color:#32506d}.fa-reddit-alien{color:#ff4500}.fa-reddit-alien:hover{background-color:#ff4500}.fa-linkedin{color:#007bb5}.fa-linkedin:hover{background-color:#007bb5}.fa-envelope{color:#444444}.fa-envelope:hover{background-color:#444444}</style></head><body><main role="main"><header role="banner"><h1 class="logo">The Data Guy</h1><div class="page-author h-card p-author"><img src="/assets/circle-cropped.png" class="author-avatar u-photo" alt="Bhuvanesh"></div><nav role="navigation"><ul><li><a href="/" >Home</a></li><li><a href="/posts/" >Posts</a></li><li><a href="/categories/" >Categories</a></li><li><a href="/tags/" >Tags</a></li><li><a href="https://medium.com/@bhuvithedataguy" >Medium Blog</a></li><li><a href="/search" >Search Here</a></li></ul></nav></header><section class="post"><h2>Reconstruct RedShift STL_QUERYTEXT using AWS Athena</h2><p><a href="https://thedataguy.in/redshift-reconstructing-sql-from-sql-querytext/">In my last post</a>, I have experimented to reconstruct the complete <code class="language-html highlighter-rouge">stl_querytext</code> table in RedShift using <code class="language-html highlighter-rouge">LISTAGG()</code> function. But there is a limitation in that. If you read AWS Doc for LISTAGG, you can’t group the rows which are more than 65535 characters. What happens if we have tens of thousands of lines of SQL queries? It’ll throw the limitation error for sure. I didn’t find a much better solution in RedShift to solve this. So I decided to use other services which are cheaper to do this work. And that’s why you are here. Yes, this time I used AWS Athena an interactive analytics platform where we can query the data in an S3 bucket directly. Lets see how to reconstruct all the queries in <code class="language-html highlighter-rouge">stl_querytext</code> table using Athena.</p><h2 id="unload-the-data">Unload the data:</h2><p>Athena can’t use the RedShift directly to query the data, we have to export the data into S3 bucket. Here we are going to do the same. But a minor change, the data in stl_querytext table has some special characters like <code class="language-html highlighter-rouge">\r</code> and <code class="language-html highlighter-rouge">\n</code> t what ill break our process in Athena. So while exporting the data, we have to replace then with whitespace.</p><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">Replace</span><span class="p">(</span><span class="k">Replace</span><span class="p">(</span><span class="nb">text</span><span class="p">,</span> <span class="s1">'</span><span class="se">\r</span><span class="s1">'</span><span class="p">,</span> <span class="s1">''</span><span class="p">),</span> <span class="s1">'</span><span class="se">\\</span><span class="s1">n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">text</span> </code></pre></figure><p>But unfortunately, I was not able to use this SQL syntax in unload command, it didn’t replace anything. (I have request AWS Support to solve this, I’ll this blog once I got the solution), but we can create a view on top of the <code class="language-html highlighter-rouge">stl_querytext</code> to replace these characters.</p><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">v_stl_querytext</span> 
<span class="k">AS</span> 
  <span class="p">(</span><span class="k">SELECT</span> <span class="n">userid</span><span class="p">,</span> 
          <span class="n">xid</span><span class="p">,</span> 
          <span class="n">pid</span><span class="p">,</span> 
          <span class="n">query</span><span class="p">,</span> 
          <span class="n">SEQUENCE</span><span class="p">,</span> 
          <span class="k">Replace</span><span class="p">(</span><span class="k">Replace</span><span class="p">(</span><span class="nb">text</span><span class="p">,</span> <span class="s1">'</span><span class="se">\r</span><span class="s1">'</span><span class="p">,</span> <span class="s1">''</span><span class="p">),</span> <span class="s1">'</span><span class="se">\\</span><span class="s1">n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">text</span> 
   <span class="k">FROM</span>   <span class="n">stl_querytext</span><span class="p">)</span> </code></pre></figure><p>Now lest unload the data to S3 bucket, make sure you have a proper IAM role to access the S3 bucket and change the bucket name and path as per your need.</p><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">unload</span> <span class="p">(</span><span class="s1">'select * from  v_stl_querytext'</span><span class="p">)</span> 
<span class="k">to</span> <span class="s1">'s3://mybucket/querytxt/querytxt.csv'</span> 
<span class="n">iam_role</span> <span class="s1">'arn:aws:iam::1111111111:role/Access-S3'</span> 
<span class="n">REGION</span> <span class="s1">'ap-south-1'</span> 
<span class="n">HEADER</span> 
<span class="k">delimiter</span> <span class="s1">'|'</span> 
<span class="n">ADDQUOTES</span><span class="p">;</span></code></pre></figure><h2 id="update-2020-03-30">Update: 2020-03-30</h2><p>Instead of creating the view, you can use the following query to unload the data.</p><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- Credit: AWS team</span>
<span class="n">unload</span> <span class="p">(</span><span class="s1">'SELECT userid,
        xid,
        pid,
        query,
        sequence,
        replace(replace(text,
        </span><span class="se">\'\\\\</span><span class="s1">n</span><span class="se">\'</span><span class="s1">,</span><span class="se">\'\'</span><span class="s1">),</span><span class="se">\'\\\\</span><span class="s1">r</span><span class="se">\'</span><span class="s1">,</span><span class="se">\'\'</span><span class="s1">) AS txt
FROM stl_querytext'</span><span class="p">)</span> 
<span class="k">to</span> <span class="s1">'s3://mybucket/querytxt/querytxt.csv'</span> 
<span class="n">iam_role</span> <span class="s1">'arn:aws:iam::1111111111:role/Access-S3'</span> 
<span class="n">REGION</span> <span class="s1">'ap-south-1'</span> 
<span class="n">HEADER</span> 
<span class="k">delimiter</span> <span class="s1">'|'</span> 
<span class="n">ADDQUOTES</span><span class="p">;</span></code></pre></figure><p>If you want to add compress, please enable it, which will improve your Athena query performance.</p><h2 id="athena-table">Athena Table:</h2><p>Now lets go and create a table in Athena to query the data in S3.</p><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">EXTERNAL</span> <span class="k">TABLE</span> <span class="nv">`stl_querytext`</span><span class="p">(</span>
  <span class="nv">`userid`</span> <span class="n">string</span> <span class="k">COMMENT</span> <span class="s1">'from deserializer'</span><span class="p">,</span> 
  <span class="nv">`xid`</span> <span class="n">string</span> <span class="k">COMMENT</span> <span class="s1">'from deserializer'</span><span class="p">,</span> 
  <span class="nv">`pid`</span> <span class="n">string</span> <span class="k">COMMENT</span> <span class="s1">'from deserializer'</span><span class="p">,</span> 
  <span class="nv">`query`</span> <span class="n">string</span> <span class="k">COMMENT</span> <span class="s1">'from deserializer'</span><span class="p">,</span> 
  <span class="nv">`sequence`</span> <span class="n">string</span> <span class="k">COMMENT</span> <span class="s1">'from deserializer'</span><span class="p">,</span> 
  <span class="nv">`text`</span> <span class="n">string</span> <span class="k">COMMENT</span> <span class="s1">'from deserializer'</span><span class="p">)</span>
<span class="k">ROW</span> <span class="n">FORMAT</span> <span class="n">SERDE</span> 
  <span class="s1">'org.apache.hadoop.hive.serde2.OpenCSVSerde'</span> 
<span class="k">WITH</span> <span class="n">SERDEPROPERTIES</span> <span class="p">(</span> 
  <span class="s1">'escapeChar'</span><span class="o">=</span><span class="s1">'</span><span class="se">\\</span><span class="s1">'</span><span class="p">,</span> 
  <span class="s1">'quoteChar'</span><span class="o">=</span><span class="s1">'</span><span class="se">\"</span><span class="s1">'</span><span class="p">,</span> 
  <span class="s1">'separatorChar'</span><span class="o">=</span><span class="s1">'|'</span><span class="p">)</span> 
<span class="n">STORED</span> <span class="k">AS</span> <span class="n">INPUTFORMAT</span> 
  <span class="s1">'org.apache.hadoop.mapred.TextInputFormat'</span> 
<span class="n">OUTPUTFORMAT</span> 
  <span class="s1">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
<span class="k">LOCATION</span>
  <span class="s1">'s3://mybucket/querytxt/'</span>
<span class="n">TBLPROPERTIES</span> <span class="p">(</span>
  <span class="s1">'skip.header.line.count'</span><span class="o">=</span><span class="s1">'1'</span><span class="p">)</span> </code></pre></figure><p>We are almost done, now let’s write some SQL queries to reconstruct the stl_querytext table.</p><h2 id="reconstruct-the-sql-queries">Reconstruct the SQL Queries:</h2><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">with</span> <span class="n">cte</span> <span class="k">as</span>
    <span class="p">(</span><span class="k">SELECT</span> <span class="n">userid</span><span class="p">,</span>
         <span class="n">xid</span><span class="p">,</span>
        <span class="n">pid</span><span class="p">,</span>
        <span class="n">query</span><span class="p">,</span>
         <span class="n">sequence</span><span class="p">,</span>
         <span class="nb">text</span><span class="p">,</span>
        <span class="n">row_number</span><span class="p">()</span>
        <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">userid</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span><span class="n">pid</span><span class="p">,</span><span class="n">query</span>
    <span class="k">ORDER</span> <span class="k">BY</span>  <span class="n">sequence</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rank</span>
    <span class="k">FROM</span> <span class="n">stl_querytext</span>
    <span class="k">GROUP</span> <span class="k">BY</span>  <span class="n">userid</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span><span class="n">pid</span><span class="p">,</span><span class="n">query</span><span class="p">,</span><span class="n">sequence</span><span class="p">,</span><span class="nb">text</span>
    <span class="k">ORDER</span> <span class="k">BY</span>  <span class="n">rank</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">userid</span><span class="p">,</span>
         <span class="n">xid</span><span class="p">,</span>
        <span class="n">pid</span><span class="p">,</span>
        <span class="n">query</span><span class="p">,</span>
        <span class="n">array_join</span><span class="p">(</span><span class="n">array_agg</span><span class="p">(</span><span class="nb">text</span><span class="p">),</span>
         <span class="s1">''</span><span class="p">)</span> <span class="k">as</span> <span class="nb">text</span>
<span class="k">FROM</span> <span class="n">cte</span>
<span class="k">GROUP</span> <span class="k">BY</span>  <span class="n">userid</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span><span class="n">pid</span><span class="p">,</span><span class="n">query</span>
<span class="k">ORDER</span> <span class="k">BY</span>  <span class="n">query</span></code></pre></figure><p><img src="/assets/Reconstrcut RedShift STL_QUERYTEXT using AWS Athena.jpg" alt="" /></p><p>Ohhh!!! Im impressed by its performance, Last time, when I perform the same activity on RedShift some times it took a min to complete, but Athena did a great job. Try it out and comment below if you face any issues.</p><h2 id="update-2020-03-30-1">Update: 2020-03-30</h2><p>I faced an issue with Athena recently, what happened is the array_agg() is not maintaining the query order. So some queries may be incorrect in the result reset. We can solve them by using <code class="language-html highlighter-rouge">array_join(array_agg(text ORDER BY sequence), '') AS text</code> and again this syntax will not support in Athena because it 1.7x version. Im not sure when AWS is going to update the Athena’s presto verison. But if you want to use presto in EMR, it’ll work. Use the following query.</p><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">with</span> <span class="n">cte</span> <span class="k">AS</span> 
    <span class="p">(</span><span class="k">SELECT</span> <span class="n">userid</span><span class="p">,</span>
         <span class="n">xid</span><span class="p">,</span>
         <span class="n">pid</span><span class="p">,</span>
         <span class="n">query</span><span class="p">,</span>
         <span class="n">sequence</span><span class="p">,</span>
         <span class="nb">text</span><span class="p">,</span>
         <span class="n">row_number</span><span class="p">()</span>
        <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">userid</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span><span class="n">pid</span><span class="p">,</span><span class="n">query</span>
    <span class="k">ORDER</span> <span class="k">BY</span>  <span class="n">sequence</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rank</span>
    <span class="k">FROM</span> <span class="n">stl_querytext</span>
    <span class="k">GROUP</span> <span class="k">BY</span>  <span class="n">userid</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span><span class="n">pid</span><span class="p">,</span><span class="n">query</span><span class="p">,</span><span class="n">sequence</span><span class="p">,</span><span class="nb">text</span>
    <span class="k">ORDER</span> <span class="k">BY</span>  <span class="n">rank</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">userid</span><span class="p">,</span>
         <span class="n">xid</span><span class="p">,</span>
         <span class="n">pid</span><span class="p">,</span>
         <span class="n">query</span><span class="p">,</span>
         <span class="n">array_join</span><span class="p">(</span><span class="n">array_agg</span><span class="p">(</span><span class="nb">text</span> <span class="k">ORDER</span> <span class="k">BY</span>  <span class="n">sequence</span><span class="p">),</span> <span class="s1">''</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">text</span>
<span class="k">FROM</span> <span class="n">cte</span>
<span class="k">GROUP</span> <span class="k">BY</span>  <span class="n">userid</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span><span class="n">pid</span><span class="p">,</span><span class="n">query</span>
<span class="k">ORDER</span> <span class="k">BY</span>  <span class="n">query</span><span class="p">;</span></code></pre></figure><span class="meta"><time datetime="2020-03-25T01:15:00+00:00">March 25, 2020</time> &middot; <a href="/tags/#aws">aws</a>, <a href="/tags/#redshift">redshift</a>, <a href="/tags/#sql">sql</a>, <a href="/tags/#athena">athena</a></span><hr> <!--<span class="meta"><time datetime="2020-03-25T01:15:00+00:00">March 25, 2020</time> &middot; <a class="post" href="/tag/aws">aws</a>, <a class="post" href="/tag/redshift">redshift</a>, <a class="post" href="/tag/sql">sql</a>, <a class="post" href="/tag/athena">athena</a></span> --></section></main></body></html>
