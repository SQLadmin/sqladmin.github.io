<!DOCTYPE html><html lang="en" ><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="/assets/css/syntax.css" rel="stylesheet"><title>RedShift Reconstructing SQL from STL_QUERYTEXT | The Data Guy</title><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="RedShift Reconstructing SQL from STL_QUERYTEXT" /><meta name="author" content="Bhuvanesh" /><meta property="og:locale" content="en_US" /><meta name="description" content="Reconstruct all SQL queries from STL_QUERYTEXT with LISTAGG and partition by" /><meta property="og:description" content="Reconstruct all SQL queries from STL_QUERYTEXT with LISTAGG and partition by" /><meta property="og:site_name" content="The Data Guy" /><meta property="og:image" content="/assets/RedShift%20Reconstructing%20SQL%20from%20STL_QUERYTEXT.jpg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-03-18T02:07:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:image" content="/assets/RedShift%20Reconstructing%20SQL%20from%20STL_QUERYTEXT.jpg" /><meta property="twitter:title" content="RedShift Reconstructing SQL from STL_QUERYTEXT" /><meta name="twitter:site" content="@bhuvithedataguy" /><meta name="twitter:creator" content="@https://twitter.com/BhuviTheDataGuy" /> <script type="application/ld+json"> {"dateModified":"2020-03-18T02:07:00+00:00","datePublished":"2020-03-18T02:07:00+00:00","image":"/assets/RedShift%20Reconstructing%20SQL%20from%20STL_QUERYTEXT.jpg","url":"/2020/03/18/redshift-reconstructing-sql-from-sql-querytext","mainEntityOfPage":{"@type":"WebPage","@id":"/2020/03/18/redshift-reconstructing-sql-from-sql-querytext"},"@type":"BlogPosting","author":{"@type":"Person","name":"Bhuvanesh"},"description":"Reconstruct all SQL queries from STL_QUERYTEXT with LISTAGG and partition by","headline":"RedShift Reconstructing SQL from STL_QUERYTEXT","@context":"https://schema.org"}</script><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.7;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}#share-bar{font-size:20px}#share-bar h4{margin-bottom:10px;font-weight:500}.share-button{margin:0px;margin-bottom:10px;margin-right:3px;border:1px solid #D3D6D2;padding:5px 10px 5px 10px}.share-button:hover{opacity:1;color:#ffffff}.fa-facebook-official{color:#3b5998}.fa-facebook-official:hover{background-color:#3b5998}.fa-twitter{color:#55acee}.fa-twitter:hover{background-color:#55acee}.fa-google-plus{color:#dd4b39}.fa-google-plus:hover{background-color:#dd4b39}.fa-pinterest-p{color:#cb2027}.fa-pinterest-p:hover{background-color:#cb2027}.fa-tumblr{color:#32506d}.fa-tumblr:hover{background-color:#32506d}.fa-reddit-alien{color:#ff4500}.fa-reddit-alien:hover{background-color:#ff4500}.fa-linkedin{color:#007bb5}.fa-linkedin:hover{background-color:#007bb5}.fa-envelope{color:#444444}.fa-envelope:hover{background-color:#444444}</style></head><body><main role="main"><header role="banner"><h1 class="logo">The Data Guy</h1><div class="page-author h-card p-author"><img src="/assets/circle-cropped.png" class="author-avatar u-photo" alt="Bhuvanesh"></div><nav role="navigation"><ul><li><a href="/" >Home</a></li><li><a href="/posts/" >Posts</a></li><li><a href="/categories/" >Categories</a></li><li><a href="/tags/" >Tags</a></li><li><a href="https://medium.com/@bhuvithedataguy" >Medium Blog</a></li><li><a href="/search" >Search Here</a></li></ul></nav></header><section class="post"><h2>RedShift Reconstructing SQL from STL_QUERYTEXT</h2><p>If you are managing the RedShift clusters then <strong>STL_QUERY</strong> and <strong>STL_QUERYTEXT</strong> tables are not new to you. STL_Query can’t hold the complete SQL query instead we can use STL_QueryText to read the complete query. But there is a challenge, we can’t read that table as it is. Since your queries are saved in multiple rows. So we need to combine all these rows into a single row with LISTAGG function which is well documented <a href="https://docs.aws.amazon.com/redshift/latest/dg/r_STL_QUERYTEXT.html">here</a>.</p><h2 id="what-is-the-real-challenge">What is the real challenge?</h2><p>From the AWS documentation example, they are showing to reconstruct the SQL for a single query. But in a production system, you may have 50k+ queries where the LISTAGG function will through some errors related to its limitation. Let’s simulate this. I ran the below query on my production RedShift Cluster.</p><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span>   <span class="n">Listagg</span><span class="p">(</span> 
         <span class="k">CASE</span> 
                  <span class="k">WHEN</span> <span class="n">Len</span><span class="p">(</span><span class="n">Rtrim</span><span class="p">(</span><span class="nb">text</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="nb">text</span> 
                  <span class="k">ELSE</span> <span class="n">Rtrim</span><span class="p">(</span><span class="nb">text</span><span class="p">)</span> 
         <span class="k">END</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span> <span class="n">within</span> <span class="k">GROUP</span> <span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">SEQUENCE</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">text</span>
<span class="k">FROM</span>     <span class="n">stl_querytext</span> <span class="k">limit</span> <span class="mi">10</span><span class="p">;</span>

<span class="n">ERROR</span><span class="p">:</span>  <span class="k">Result</span> <span class="k">size</span> <span class="n">exceeds</span> <span class="n">LISTAGG</span> <span class="k">limit</span>
<span class="n">DETAIL</span><span class="p">:</span>
  <span class="c1">-----------------------------------------------</span>
  <span class="n">error</span><span class="p">:</span>  <span class="k">Result</span> <span class="k">size</span> <span class="n">exceeds</span> <span class="n">LISTAGG</span> <span class="k">limit</span>
  <span class="n">code</span><span class="p">:</span>      <span class="mi">8001</span>
  <span class="n">context</span><span class="p">:</span>   <span class="n">LISTAGG</span> <span class="k">limit</span><span class="p">:</span> <span class="mi">65535</span>
  <span class="n">query</span><span class="p">:</span>     <span class="mi">180132</span>
  <span class="k">location</span><span class="p">:</span>  <span class="mi">0</span><span class="p">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">228</span>
  <span class="n">process</span><span class="p">:</span>   <span class="n">query0_78_180132</span> <span class="p">[</span><span class="n">pid</span><span class="o">=</span><span class="mi">23735</span><span class="p">]</span>
  <span class="c1">-----------------------------------------------</span></code></pre></figure><h2 id="why-this-error">Why this error?</h2><p>If you read the LISTAGG function details, If the result set is larger than the maximum VARCHAR size (64K – 1, or 65535), then LISTAGG returns the error. Here I have more than 50k+ rows. So the overall characters will not fit in the result set.</p><h2 id="what-is-the-solution">What is the solution?:</h2><p>If we run the reconstruct query one by one instead of all then the resultset will fit into the LISTAGG’s limitation. Lets say one of my queries split into 2 rows in the STL_QUERYTEXT table.</p><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="nb">text</span> 
<span class="k">FROM</span>   <span class="n">stl_querytext</span> 
<span class="k">WHERE</span>  <span class="n">query</span> <span class="o">=</span> <span class="mi">97729</span> 
<span class="k">ORDER</span>  <span class="k">BY</span> <span class="n">SEQUENCE</span><span class="p">;</span> </code></pre></figure><p><img src="/assets/RedShift Reconstructing SQL from STL_QUERYTEXT1.jpg" alt="" /></p><p>First, process these two rows and then process another query and then the next one.</p><h2 id="how">How?</h2><p>We have <code class="language-html highlighter-rouge">userid</code>,<code class="language-html highlighter-rouge">pid</code>,<code class="language-html highlighter-rouge">xid</code>,<code class="language-html highlighter-rouge">query</code> columns are common between these two rows. So partition your resultset by query wise. Then do the LISTAGG.</p><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">LISTAGG</span><span class="p">(</span>
      <span class="k">CASE</span>
        <span class="k">WHEN</span> <span class="n">LEN</span><span class="p">(</span><span class="n">RTRIM</span><span class="p">(</span><span class="nb">text</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="nb">text</span>
        <span class="k">ELSE</span> <span class="n">RTRIM</span><span class="p">(</span><span class="nb">text</span><span class="p">)</span>
      <span class="k">END</span><span class="p">,</span>
      <span class="s1">''</span>
    <span class="p">)</span> <span class="n">within</span> <span class="k">group</span> <span class="p">(</span>
      <span class="k">order</span> <span class="k">by</span>
        <span class="n">sequence</span>
    <span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">by</span> <span class="n">userid</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span> </code></pre></figure><h2 id="replace-n-and-r-characters">Replace \n and \r characters:</h2><p>If you are going to run this query from psql client most of the queries starts with <code class="language-html highlighter-rouge">\r\nselect * from mytbl</code> or any GUI based tools will return <code class="language-html highlighter-rouge">\n</code> characters.</p><ul><li>\r actually a carriage return</li><li>\n is not a new line its a sting. So we have to replace twice.</li></ul><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">replace</span><span class="p">(</span><span class="k">replace</span><span class="p">(</span>
    <span class="n">LISTAGG</span><span class="p">(</span>
      <span class="k">CASE</span>
        <span class="k">WHEN</span> <span class="n">LEN</span><span class="p">(</span><span class="n">RTRIM</span><span class="p">(</span><span class="nb">text</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="nb">text</span>
        <span class="k">ELSE</span> <span class="n">RTRIM</span><span class="p">(</span><span class="nb">text</span><span class="p">)</span>
      <span class="k">END</span><span class="p">,</span>
      <span class="s1">''</span>
    <span class="p">)</span> <span class="n">within</span> <span class="k">group</span> <span class="p">(</span>
      <span class="k">order</span> <span class="k">by</span>
        <span class="n">sequence</span>
    <span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">by</span> <span class="n">userid</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">query</span><span class="p">),</span>
    <span class="s1">'</span><span class="se">\r</span><span class="s1">'</span><span class="p">,</span><span class="s1">''</span> 
  <span class="p">),</span> <span class="s1">'</span><span class="se">\\</span><span class="s1">n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span></code></pre></figure><h2 id="final-view">Final View:</h2><p>For east management, Im going to create a view on top of the STL_QUERYTEXT table to return the reconstructed SQL for all the queries.</p><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">recon_stl_querytext</span> 
<span class="k">AS</span> 
  <span class="p">(</span><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">userid</span><span class="p">,</span> 
                   <span class="n">xid</span><span class="p">,</span> 
                   <span class="n">pid</span><span class="p">,</span> 
                   <span class="n">query</span><span class="p">,</span> 
                   <span class="k">Replace</span><span class="p">(</span><span class="k">Replace</span><span class="p">(</span><span class="n">Listagg</span><span class="p">(</span><span class="k">CASE</span> 
                                             <span class="k">WHEN</span> <span class="n">Len</span><span class="p">(</span><span class="n">Rtrim</span><span class="p">(</span><span class="nb">text</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="nb">text</span> 
                                             <span class="k">ELSE</span> <span class="n">Rtrim</span><span class="p">(</span><span class="nb">text</span><span class="p">)</span> 
                                           <span class="k">END</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span> 
                                     <span class="n">within</span> <span class="k">GROUP</span> <span class="p">(</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">SEQUENCE</span> <span class="p">)</span> <span class="n">over</span> <span class="p">(</span> 
                                       <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">userid</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">query</span><span class="p">),</span> 
                           <span class="s1">'</span><span class="se">\r</span><span class="s1">'</span> 
                           <span class="p">,</span> <span class="s1">''</span><span class="p">),</span> <span class="s1">'</span><span class="se">\\</span><span class="s1">n'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span> 
                   <span class="k">AS</span> <span class="nb">text</span> 
   <span class="k">FROM</span>   <span class="n">stl_querytext</span> 
   <span class="k">ORDER</span>  <span class="k">BY</span> <span class="mi">1</span><span class="p">,</span> 
             <span class="mi">2</span><span class="p">,</span> 
             <span class="mi">3</span><span class="p">,</span> 
             <span class="mi">4</span><span class="p">);</span> </code></pre></figure><p>Now you can view the proper data from this view.</p><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="o">*</span> 
<span class="k">FROM</span>   <span class="n">recon_stl_querytext</span> 
<span class="k">WHERE</span>  <span class="n">query</span> <span class="o">=</span> <span class="mi">97729</span><span class="p">;</span> </code></pre></figure><p><img src="/assets/RedShift Reconstructing SQL from STL_QUERYTEXT2.jpg" alt="" /></p><p>I hope this helps you to get the overall consolidated view on the query history. If you are interested in how to <a href="https://medium.com/searce/audit-redshift-historical-queries-with-pgbadger-619f7f43fbd0">Audit RedShift Historical Queries With pgbadger please click here</a>.</p><span class="meta"><time datetime="2020-03-18T02:07:00+00:00">March 18, 2020</time> &middot; <a href="/tags/#aws">aws</a>, <a href="/tags/#redshift">redshift</a>, <a href="/tags/#sql">sql</a></span><hr> <!--<span class="meta"><time datetime="2020-03-18T02:07:00+00:00">March 18, 2020</time> &middot; <a class="post" href="/tag/aws">aws</a>, <a class="post" href="/tag/redshift">redshift</a>, <a class="post" href="/tag/sql">sql</a></span> --></section></main></body></html>
