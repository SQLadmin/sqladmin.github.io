<!DOCTYPE html><html lang="en" ><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="/assets/css/syntax.css" rel="stylesheet"><title>RedShift Kill All Locking Sessions On A Table | The Data Guy</title><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="RedShift Kill All Locking Sessions On A Table" /><meta name="author" content="Bhuvanesh" /><meta property="og:locale" content="en_US" /><meta name="description" content="Redshift kill all locking sessions on a particular table using a stored procedure. It’ll collect all locking sessions pid and kill them in one shot." /><meta property="og:description" content="Redshift kill all locking sessions on a particular table using a stored procedure. It’ll collect all locking sessions pid and kill them in one shot." /><meta property="og:site_name" content="The Data Guy" /><meta property="og:image" content="/assets/RedShift%20Kill%20All%20Locking%20Sessions%20On%20A%20Table.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-12-25T23:30:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:image" content="/assets/RedShift%20Kill%20All%20Locking%20Sessions%20On%20A%20Table.png" /><meta property="twitter:title" content="RedShift Kill All Locking Sessions On A Table" /><meta name="twitter:site" content="@bhuvithedataguy" /><meta name="twitter:creator" content="@https://twitter.com/BhuviTheDataGuy" /> <script type="application/ld+json"> {"dateModified":"2019-12-25T23:30:00+00:00","datePublished":"2019-12-25T23:30:00+00:00","image":"/assets/RedShift%20Kill%20All%20Locking%20Sessions%20On%20A%20Table.png","url":"/2019/12/25/redshift-kill-all-locking-sessions-on-a-table","mainEntityOfPage":{"@type":"WebPage","@id":"/2019/12/25/redshift-kill-all-locking-sessions-on-a-table"},"@type":"BlogPosting","author":{"@type":"Person","name":"Bhuvanesh"},"description":"Redshift kill all locking sessions on a particular table using a stored procedure. It’ll collect all locking sessions pid and kill them in one shot.","headline":"RedShift Kill All Locking Sessions On A Table","@context":"https://schema.org"}</script><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.7;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}#share-bar{font-size:20px}#share-bar h4{margin-bottom:10px;font-weight:500}.share-button{margin:0px;margin-bottom:10px;margin-right:3px;border:1px solid #D3D6D2;padding:5px 10px 5px 10px}.share-button:hover{opacity:1;color:#ffffff}.fa-facebook-official{color:#3b5998}.fa-facebook-official:hover{background-color:#3b5998}.fa-twitter{color:#55acee}.fa-twitter:hover{background-color:#55acee}.fa-google-plus{color:#dd4b39}.fa-google-plus:hover{background-color:#dd4b39}.fa-pinterest-p{color:#cb2027}.fa-pinterest-p:hover{background-color:#cb2027}.fa-tumblr{color:#32506d}.fa-tumblr:hover{background-color:#32506d}.fa-reddit-alien{color:#ff4500}.fa-reddit-alien:hover{background-color:#ff4500}.fa-linkedin{color:#007bb5}.fa-linkedin:hover{background-color:#007bb5}.fa-envelope{color:#444444}.fa-envelope:hover{background-color:#444444}</style></head><body><main role="main"><header role="banner"><h1 class="logo">The Data Guy</h1><div class="page-author h-card p-author"><img src="/assets/circle-cropped.png" class="author-avatar u-photo" alt="Bhuvanesh"></div><nav role="navigation"><ul><li><a href="/" >Home</a></li><li><a href="/posts/" >Posts</a></li><li><a href="/categories/" >Categories</a></li><li><a href="/tags/" >Tags</a></li><li><a href="https://medium.com/@bhuvithedataguy" >Medium Blog</a></li><li><a href="/search" >Search Here</a></li></ul></nav></header><section class="post"><h2>RedShift Kill All Locking Sessions On A Table</h2><p>In any relational database, if you didn’t close the session properly, then it’ll lock your DDL queries. It’s applicable to RedShift as well. A few days back I got a scenario that we have to run some DROP TABLE commands to create some lookup tables. But every time while triggering this DDL it got stuck. Then we realize there were some sessions that are still open and those sessions are causing this locking. There we 30+ sessions. I know we can fix this by properly closing the session from the application side. But in some emergency cases, we need to kill all open sessions or locking session in Redshift.</p><p>Then my DBA brain was telling me to create a stored procedure to get all the locking sessions and kill them in one shot. I never recommend running this all the time. But if you are a DBA or RedShift Admin, then you need to have these kinds of handy toolkits.</p><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">replace</span> <span class="k">PROCEDURE</span> <span class="n">sp_superkill</span><span class="p">(</span><span class="k">table_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span> 
<span class="k">LANGUAGE</span> <span class="n">plpgsql</span> 
<span class="k">AS</span> 
  <span class="err">$$</span> 
  <span class="k">DECLARE</span> 
    <span class="n">list</span> <span class="n">RECORD</span><span class="p">;</span> 
    <span class="n">terminate_query</span>      <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50000</span><span class="p">);</span> 
    <span class="n">drop_query</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50000</span><span class="p">);</span> 
  <span class="k">BEGIN</span> 
    <span class="k">FOR</span> <span class="n">list</span> <span class="k">IN</span> 
    <span class="k">SELECT</span> <span class="n">a</span><span class="p">.</span><span class="n">datname</span><span class="p">,</span> 
           <span class="k">c</span><span class="p">.</span><span class="n">relname</span><span class="p">,</span> 
           <span class="n">a</span><span class="p">.</span><span class="n">procpid</span> 
    <span class="k">FROM</span>   <span class="n">pg_stat_activity</span> <span class="n">a</span> 
    <span class="k">join</span>   <span class="n">pg_locks</span> <span class="n">l</span> 
    <span class="k">ON</span>     <span class="n">l</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">procpid</span> 
    <span class="k">join</span>   <span class="n">pg_class</span> <span class="k">c</span> 
    <span class="k">ON</span>     <span class="k">c</span><span class="p">.</span><span class="n">oid</span> <span class="o">=</span> <span class="n">l</span><span class="p">.</span><span class="n">relation</span> 
    <span class="k">WHERE</span>  <span class="k">c</span><span class="p">.</span><span class="n">relname</span><span class="o">=</span><span class="k">table_name</span> 

    <span class="n">LOOP</span> 
    <span class="n">terminate_query</span><span class="p">:</span><span class="o">=</span> <span class="s1">'select pg_terminate_backend('</span><span class="o">||</span><span class="n">list</span><span class="p">.</span><span class="n">procpid</span><span class="o">||</span><span class="s1">')'</span><span class="p">;</span> 
    <span class="n">RAISE</span> <span class="n">info</span> <span class="s1">'Killing pid [%]'</span><span class="p">,</span> <span class="n">list</span><span class="p">.</span><span class="n">procpid</span><span class="p">;</span> 
    <span class="k">EXECUTE</span> <span class="n">terminate_query</span><span class="p">;</span> 
  <span class="k">END</span> <span class="n">LOOP</span><span class="p">;</span> 
  
  <span class="c1">--drop_query:='drop table '||table_name; --Add DDL If you want</span>
  <span class="c1">--EXECUTE drop_query; --Add DDL If you want</span>
<span class="k">END</span><span class="p">;</span> 
<span class="err">$$</span><span class="p">;</span></code></pre></figure><h2 id="testing-the-procedure">Testing the Procedure:</h2><p>Open multiple sessions for a table and don’t close them.</p><figure class="highlight"><pre><code class="language-shell" data-lang="shell">START TRANSACTIONS<span class="p">;</span>
Select col1 from my_table limit 1<span class="p">;</span></code></pre></figure><p>Do open a few more sessions. Then run the stored procedure.</p><figure class="highlight"><pre><code class="language-shell" data-lang="shell">call sp_superkill<span class="o">(</span><span class="s1">'my_table'</span><span class="o">)</span><span class="p">;</span>

INFO:  Killing pid <span class="o">[</span>11734]
INFO:  Killing pid <span class="o">[</span>11735]
INFO:  Killing pid <span class="o">[</span>11738]
INFO:  Killing pid <span class="o">[</span>11739]
CALL</code></pre></figure><span class="meta"><time datetime="2019-12-25T23:30:00+00:00">December 25, 2019</time> &middot; <a href="/tags/#aws">aws</a>, <a href="/tags/#redshift">redshift</a>, <a href="/tags/#sql">sql</a></span><hr> <!--<span class="meta"><time datetime="2019-12-25T23:30:00+00:00">December 25, 2019</time> &middot; <a class="post" href="/tag/aws">aws</a>, <a class="post" href="/tag/redshift">redshift</a>, <a class="post" href="/tag/sql">sql</a></span> --></section></main></body></html>
