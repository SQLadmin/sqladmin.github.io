<!DOCTYPE html><html lang="en" ><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="/assets/css/syntax.css" rel="stylesheet"><title>Where GCP Internal TCP Load Balancer Fails | The Data Guy</title><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="Where GCP Internal TCP Load Balancer Fails" /><meta name="author" content="Bhuvanesh" /><meta property="og:locale" content="en_US" /><meta name="description" content="GCP Internal TCP load balancer route the traffic to the same node the traffic source is the node which is under the load balancer" /><meta property="og:description" content="GCP Internal TCP load balancer route the traffic to the same node the traffic source is the node which is under the load balancer" /><meta property="og:site_name" content="The Data Guy" /><meta property="og:image" content="/assets/Where%20GCP%20Internal%20TCP%20Load%20Balancer%20Fails.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-10-29T08:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:image" content="/assets/Where%20GCP%20Internal%20TCP%20Load%20Balancer%20Fails.png" /><meta property="twitter:title" content="Where GCP Internal TCP Load Balancer Fails" /><meta name="twitter:site" content="@bhuvithedataguy" /><meta name="twitter:creator" content="@https://twitter.com/BhuviTheDataGuy" /> <script type="application/ld+json"> {"dateModified":"2019-10-29T08:00:00+00:00","datePublished":"2019-10-29T08:00:00+00:00","image":"/assets/Where%20GCP%20Internal%20TCP%20Load%20Balancer%20Fails.png","url":"/2019/10/29/where-gcp-internal-load-balancer-fails","mainEntityOfPage":{"@type":"WebPage","@id":"/2019/10/29/where-gcp-internal-load-balancer-fails"},"@type":"BlogPosting","author":{"@type":"Person","name":"Bhuvanesh"},"description":"GCP Internal TCP load balancer route the traffic to the same node the traffic source is the node which is under the load balancer","headline":"Where GCP Internal TCP Load Balancer Fails","@context":"https://schema.org"}</script><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.7;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}#share-bar{font-size:20px}#share-bar h4{margin-bottom:10px;font-weight:500}.share-button{margin:0px;margin-bottom:10px;margin-right:3px;border:1px solid #D3D6D2;padding:5px 10px 5px 10px}.share-button:hover{opacity:1;color:#ffffff}.fa-facebook-official{color:#3b5998}.fa-facebook-official:hover{background-color:#3b5998}.fa-twitter{color:#55acee}.fa-twitter:hover{background-color:#55acee}.fa-google-plus{color:#dd4b39}.fa-google-plus:hover{background-color:#dd4b39}.fa-pinterest-p{color:#cb2027}.fa-pinterest-p:hover{background-color:#cb2027}.fa-tumblr{color:#32506d}.fa-tumblr:hover{background-color:#32506d}.fa-reddit-alien{color:#ff4500}.fa-reddit-alien:hover{background-color:#ff4500}.fa-linkedin{color:#007bb5}.fa-linkedin:hover{background-color:#007bb5}.fa-envelope{color:#444444}.fa-envelope:hover{background-color:#444444}</style></head><body><main role="main"><header role="banner"><h1 class="logo">The Data Guy</h1><div class="page-author h-card p-author"><img src="/assets/circle-cropped.png" class="author-avatar u-photo" alt="Bhuvanesh"></div><nav role="navigation"><ul><li><a href="/" >Home</a></li><li><a href="/posts/" >Posts</a></li><li><a href="/categories/" >Categories</a></li><li><a href="/tags/" >Tags</a></li><li><a href="https://medium.com/@bhuvithedataguy" >Medium Blog</a></li><li><a href="/search" >Search Here</a></li></ul></nav></header><section class="post"><h2>Where GCP Internal TCP Load Balancer Fails</h2><p>GCP’s Load balancers are globally scalable and its the unique identify for GCP while comparing its competitors. Generally GCP’s networking is very strong and mature than other Cloud providers. Recently I was working with a SQL Server setup which integrates the GCP Internal TCP load balancer. During that PoC setup I found this strange behaviour and then I ignored this problem because I thought its something related to SQL server.</p><h2 id="the-poc-setup">The PoC Setup:</h2><p>I wanted to reproduce this scenario in simple web server stack. So I created 2 apache web servers and put them under the Internal TCP load balancer.</p><ul><li><strong>Web Server 1</strong>: the index page will show <code class="language-html highlighter-rouge">This is from Node1</code></li><li><strong>Web Server 2</strong>: the index page will show <code class="language-html highlighter-rouge">This is from Node2</code></li><li><strong>Load balancer IP:</strong> 10.128.0.46</li></ul><p>The health check is passed and Im able to see both nodes are healthy. Then I tried to CURL the load balancer’s IP from the other VM which is on the same subnet. The traffic is routed to node 1 and second time node2. Till now everything looks good.</p><h3 id="curl-from-a-vm-in-the-same-subnet">Curl from a VM in the same subnet:</h3><figure class="highlight"><pre><code class="language-shell" data-lang="shell">    <span class="c"># Curl 1st time</span>
    curl 10.128.0.46
    &lt;html&gt;
            &lt;body&gt;
                    &lt;H1&gt; This is from Node1 &lt;/H2&gt;
            &lt;/body&gt;
    &lt;/html&gt;
    
    <span class="c"># Curl 2nd time</span>
    
    curl 10.128.0.46
    &lt;html&gt;
            &lt;body&gt;
                    &lt;H1&gt; This is from Node2 &lt;/H2&gt;
            &lt;/body&gt;
    &lt;/html&gt;</code></pre></figure><h2 id="the-strange-behaviour-in-my-previous-setup">The strange behaviour in my previous setup:</h2><p>In my SQL Server setup the issue I faced is, Its an alwayson availability group setup and the TCP Load balancer will route the traffic to the Primary Node. <a href="https://medium.com/searce/configure-external-listener-for-always-on-availability-groups-in-gcp-e1ae1c9632d1">The complete setup of Configuring the external Load balancer for SQL server availability groups is here</a>. There I have some packages where I need to talk to the Primary Node. The package will be executing from the both primary and secondary. It tried to talk to the Load balancer IP. But from Primary node and other nodes in the subnet always properly reached the Primary node via the TCP load balancer. But the secondary server is not able to reach, instead it was showing the role is Secondary. Then I connected to SQL server using load balancer IP and print the node name. It was showing the secondary server’s name.</p><p>Then I noticed, the traffic is always routed to the Node 2 if Im trying to access the Load balancer IP from the node2.</p><h2 id="issue-verified">Issue Verified:</h2><p>From apache webserver’s PoC, I tried to curl the Load Balancer’s from Node 1 and then Node2.</p><h3 id="node-1">Node 1:</h3><figure class="highlight"><pre><code class="language-shell" data-lang="shell">    root@bhuvi-node1:/var/www/html# curl 10.128.0.46
    &lt;html&gt;
            &lt;body&gt;
                    &lt;H1&gt; This is from Node1 &lt;/H2&gt;
            &lt;/body&gt;
    &lt;/html&gt;     
    root@bhuvi-node1:/var/www/html# curl 10.128.0.46
    &lt;html&gt;
            &lt;body&gt;
                    &lt;H1&gt; This is from Node1 &lt;/H2&gt;
            &lt;/body&gt;
    &lt;/html&gt;      
    root@bhuvi-node1:/var/www/html# </code></pre></figure><h3 id="node-2">Node 2:</h3><figure class="highlight"><pre><code class="language-shell" data-lang="shell">    root@bhuvi-node1:/var/www/html# curl 10.128.0.46
    &lt;html&gt;
            &lt;body&gt;
                    &lt;H1&gt; This is from Node2 &lt;/H2&gt;
            &lt;/body&gt;
    &lt;/html&gt;      
    root@bhuvi-node1:/var/www/html# curl 10.128.0.46
    &lt;html&gt;
            &lt;body&gt;
                    &lt;H1&gt; This is from Node2 &lt;/H2&gt;
            &lt;/body&gt;
    &lt;/html&gt;    
    root@bhuvi-node1:/var/www/html# </code></pre></figure><blockquote><p>Its proving that the internal TCP load balancer routes the traffic to the same node in the source packet is coming from the node which is part of the load balancer.</p></blockquote><h2 id="the-cause-for-this-routing">The Cause for this routing:</h2><p>The exact reason for this behaviour is not a bug or an issue. Its the design of the TCP load balancer in GCP. What happened is, the moment when you add the instance group to the load balancer’s backend, then GCP will automatically add a route in your VM that the Load balancer’s IP is the Local host’s IP.</p><h3 id="node-1-1">Node 1:</h3><figure class="highlight"><pre><code class="language-shell" data-lang="shell">    <span class="nb">sudo </span>ip route list table <span class="nb">local
    local </span>10.128.0.40 dev ens4 proto kernel scope host src 10.128.0.40 
    <span class="nb">local </span>10.128.0.46 dev ens4 proto 66 scope host 
    broadcast 127.0.0.0 dev lo proto kernel scope <span class="nb">link </span>src 127.0.0.1 
    <span class="nb">local </span>127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1 
    <span class="nb">local </span>127.0.0.1 dev lo proto kernel scope host src 127.0.0.1 
    broadcast 127.255.255.255 dev lo proto kernel scope <span class="nb">link </span>src 127.0.0.1  </code></pre></figure><h3 id="node-2-1">Node 2:</h3><figure class="highlight"><pre><code class="language-shell" data-lang="shell">    <span class="nb">sudo </span>ip route list table <span class="nb">local
    local </span>10.128.0.41 dev ens4 proto kernel scope host src 10.128.0.41 
    <span class="nb">local </span>10.128.0.46 dev ens4 proto 66 scope host 
    broadcast 127.0.0.0 dev lo proto kernel scope <span class="nb">link </span>src 127.0.0.1 
    <span class="nb">local </span>127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1 
    <span class="nb">local </span>127.0.0.1 dev lo proto kernel scope host src 127.0.0.1 
    broadcast 127.255.255.255 dev lo proto kernel scope <span class="nb">link </span>src 127.0.0.1 </code></pre></figure><p>Both nodes are showing that <code class="language-html highlighter-rouge">local 10.128.0.46 dev ens4 proto 66 scope host</code> , so whenever we tried to access the load balancer’s IP, then the OS route table will route the traffic to the same node.</p><blockquote><p>I have verified this with GCP support team.</p></blockquote><h2 id="is-this-a-serious-issue">Is this a serious Issue:</h2><p><strong>Not at all.</strong> No one will try to access the load balancer from the nodes which are under the load balancer(Except some cases like mine).</p><h2 id="what-about-httphttps-load-balancer">What about HTTP/HTTPS Load balancer?:</h2><p>I tried to reproduce the same issue with HTTP/HTTPS load balancer. There I didn’t see this problem.</p><span class="meta"><time datetime="2019-10-29T08:00:00+00:00">October 29, 2019</time> &middot; <a href="/tags/#gcp">gcp</a>, <a href="/tags/#networking">networking</a>, <a href="/tags/#load balancer">load balancer</a></span><hr> <!--<span class="meta"><time datetime="2019-10-29T08:00:00+00:00">October 29, 2019</time> &middot; <a class="post" href="/tag/gcp">gcp</a>, <a class="post" href="/tag/networking">networking</a>, <a class="post" href="/tag/load balancer">load balancer</a></span> --></section></main></body></html>
