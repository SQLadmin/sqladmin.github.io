<!DOCTYPE html><html lang="en" ><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="/assets/css/syntax.css" rel="stylesheet"><title>CloudWatch Custom Log Filter Alarm For Kinesis Load Failed Event | The Data Guy</title><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="CloudWatch Custom Log Filter Alarm For Kinesis Load Failed Event" /><meta name="author" content="Bhuvanesh" /><meta property="og:locale" content="en_US" /><meta name="description" content="Setup the cloudwatch custom log filter for sending email alert for kinesis firehose load failed event for RedShift" /><meta property="og:description" content="Setup the cloudwatch custom log filter for sending email alert for kinesis firehose load failed event for RedShift" /><meta property="og:site_name" content="The Data Guy" /><meta property="og:image" content="/assets/CloudWatch%20Custom%20Log%20Filter%20Alarm%20For%20Kinesis%20Load%20Failed%20Event.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-10-01T05:30:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:image" content="/assets/CloudWatch%20Custom%20Log%20Filter%20Alarm%20For%20Kinesis%20Load%20Failed%20Event.jpeg" /><meta property="twitter:title" content="CloudWatch Custom Log Filter Alarm For Kinesis Load Failed Event" /><meta name="twitter:site" content="@bhuvithedataguy" /><meta name="twitter:creator" content="@https://twitter.com/BhuviTheDataGuy" /> <script type="application/ld+json"> {"dateModified":"2019-10-01T05:30:00+00:00","datePublished":"2019-10-01T05:30:00+00:00","image":"/assets/CloudWatch%20Custom%20Log%20Filter%20Alarm%20For%20Kinesis%20Load%20Failed%20Event.jpeg","url":"/2019/10/01/cloudwatch-custom-log-filter-alarm-for-kinesis-load-failed-event","mainEntityOfPage":{"@type":"WebPage","@id":"/2019/10/01/cloudwatch-custom-log-filter-alarm-for-kinesis-load-failed-event"},"@type":"BlogPosting","author":{"@type":"Person","name":"Bhuvanesh"},"description":"Setup the cloudwatch custom log filter for sending email alert for kinesis firehose load failed event for RedShift","headline":"CloudWatch Custom Log Filter Alarm For Kinesis Load Failed Event","@context":"https://schema.org"}</script><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.7;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}#share-bar{font-size:20px}#share-bar h4{margin-bottom:10px;font-weight:500}.share-button{margin:0px;margin-bottom:10px;margin-right:3px;border:1px solid #D3D6D2;padding:5px 10px 5px 10px}.share-button:hover{opacity:1;color:#ffffff}.fa-facebook-official{color:#3b5998}.fa-facebook-official:hover{background-color:#3b5998}.fa-twitter{color:#55acee}.fa-twitter:hover{background-color:#55acee}.fa-google-plus{color:#dd4b39}.fa-google-plus:hover{background-color:#dd4b39}.fa-pinterest-p{color:#cb2027}.fa-pinterest-p:hover{background-color:#cb2027}.fa-tumblr{color:#32506d}.fa-tumblr:hover{background-color:#32506d}.fa-reddit-alien{color:#ff4500}.fa-reddit-alien:hover{background-color:#ff4500}.fa-linkedin{color:#007bb5}.fa-linkedin:hover{background-color:#007bb5}.fa-envelope{color:#444444}.fa-envelope:hover{background-color:#444444}</style></head><body><main role="main"><header role="banner"><h1 class="logo">The Data Guy</h1><div class="page-author h-card p-author"><img src="/assets/circle-cropped.png" class="author-avatar u-photo" alt="Bhuvanesh"></div><nav role="navigation"><ul><li><a href="/" >Home</a></li><li><a href="/posts/" >Posts</a></li><li><a href="/categories/" >Categories</a></li><li><a href="/tags/" >Tags</a></li><li><a href="https://medium.com/@bhuvithedataguy" >Medium Blog</a></li><li><a href="/search" >Search Here</a></li></ul></nav></header><section class="post"><h2>CloudWatch Custom Log Filter Alarm For Kinesis Load Failed Event</h2><p>Kinesis Firehose is pushing the realtime data to S3, Redshift, ElasticSearch, and Splunk for realtime/Near real-time analytics. Sometime the target may not available due to maintenance or any reason. So the Kinesis will automatically push the data to S3 and create the manifest file in the <code class="language-html highlighter-rouge">errors</code> directory. Then later we can reload the data into our targets. But unfortunately, there is no one-step action to set notification if the load is failed. In this blog, im writing how can we setup Cloudwatch custom log filter alarm for kinesis load failed events.</p><h2 id="kinesis-firehose-setup">Kinesis Firehose Setup:</h2><p>Im sending my clickstream data to Kinesis Firehose and then there is an intermediate S3 bucket to store the data in <code class="language-html highlighter-rouge">JSON</code> format with <code class="language-html highlighter-rouge">GZIP</code> compression. And then the data will go to RedShift for further analytics purpose.</p><h2 id="redshift-failures-in-kinesis">RedShift Failures in Kinesis:</h2><p>Kinesis will not send the data to Redshift in many cases. Here are some most common errors.</p><ol><li>Redshift.AuthenticationFailed</li><li>Redshift.ConnectionFailed</li><li>Redshift.ReadOnlyCluster</li><li>Redshift.DiskFull</li></ol><p>There are many other errors you can refer to the below Reference section to read more about the types of errors.</p><h2 id="customer-log-filter-in-cloudwatch">Customer Log Filter in CloudWatch:</h2><p>To setup the email notification, we need to filter the Cloudwatch logs with the keyword <code class="language-html highlighter-rouge">errorCode</code> and <code class="language-html highlighter-rouge">RedShift</code>.</p><ul><li>Go to Cloudwatch –&gt; Logs</li><li>Click the radio button on <code class="language-html highlighter-rouge">/aws/kinesisfirehose/your-stream-name</code></li><li>Create Metric Filter.</li><li>Filter Pattern: <code class="language-html highlighter-rouge">[w1!=errorCode<span class="err">&amp;&amp;</span>w1!=Redshift] </code>( <em>This means the string errorCode and RedShift will be on the same line</em>).</li><li>Select Log Data to Test: RedShiftDelivery</li><li>Test pattern. (it’ll give you some X number of matching lines)</li></ul><p><img src="/assets/CloudWatch Custom Log Filter Alarm For Kinesis Load Failed Event1.jpg" alt="" /></p><p>Now assign the metric.</p><ul><li>Filter Name: kinesis-redshift-error</li><li>Filter Pattern: it’ll automatically select the pattern which we used in the previous step.</li><li>Metic Name: redshift-kinesis-error</li><li>Metic Value: 1</li><li>Click on the save filter.</li></ul><p><img src="/assets/CloudWatch Custom Log Filter Alarm For Kinesis Load Failed Event2.jpg" alt="" /></p><h2 id="create-the-alarm">Create the Alarm:</h2><p>Once the clicked the Save Filter option you can see the window. Or you go to Cloudwatch –&gt; logs –&gt; /aws/kinesisfirehose/your-stream-name on Metric Filters column you can see 1 filter.</p><p><img src="/assets/CloudWatch Custom Log Filter Alarm For Kinesis Load Failed Event4.jpg" alt="" /></p><p><img src="/assets/CloudWatch Custom Log Filter Alarm For Kinesis Load Failed Event3.jpg" alt="" /></p><ol><li>Click on the Create Alarm link.</li><li>Under the metric option: select the period as 10 seconds.</li><li>Conditions: Threshold type –&gt; Static</li><li>Define the alarm condition –&gt; Greater/Equal</li><li>Define the threshold value –&gt; 1</li><li>Under the Additional Configuration: Datapoints to alarm <code class="language-html highlighter-rouge">1 out of 1</code></li><li>Missing data treatment: Treat Missing Data as Good.</li><li>Rest of the things are easy, you can select an SNS topic for sending an email alert.</li></ol><p><img src="/assets/CloudWatch Custom Log Filter Alarm For Kinesis Load Failed Event5.jpg" alt="" /></p><p><img src="/assets/CloudWatch Custom Log Filter Alarm For Kinesis Load Failed Event8.jpg" alt="" /></p><h3 id="why-treat-missing-data-as-good">Why Treat Missing Data as Good?</h3><p>In the Cloudwatch, we’ll not get any logs unless kinesis gets some errors. So it’ll not get any values for the metric. Then your alarm will go to insufficient state. We are interested in only getting email alerts. So if my CloudWatch didn’t get any errors then this Alarm will go to OK state.</p><h2 id="test-this-alarm">Test this Alarm:</h2><p>For testing purpose, I changed my redshift password in Kinesis Firehose. Then I got this error from the Cloudwatch.</p><p><strong>CloudWatch Log:</strong></p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>{
    "deliveryStreamARN": "arn:aws:firehose:ap-south-1:XXXXXXXX/Kinesis-test-stream",
    "destination": "jdbc:redshift://XXXXXXXXXX.redshift.amazonaws.com:5439/test",
    "deliveryStreamVersionId": 11,
    "message": "The provided user name and password failed authentication. Provide valid user name and password.",
    "errorCode": "Redshift.AuthenticationFailed"
}
</code></pre></div></div><p><strong>CloudWatch Alarm:</strong></p><p>You can see a blue line or a blue dot which indicates that the pattern matched.</p><p><img src="/assets/CloudWatch Custom Log Filter Alarm For Kinesis Load Failed Event6.jpg" alt="" /></p><p><strong>Email:</strong></p><p>Yes, and I got the email from SNS topic.</p><p><img src="/assets/CloudWatch Custom Log Filter Alarm For Kinesis Load Failed Event7.jpg" alt="" /></p><h2 id="further-references">Further References:</h2><ol><li><a href="https://docs.aws.amazon.com/firehose/latest/dev/monitoring-with-cloudwatch-logs.html">Learn more about all error events in Kinesis Firehose</a></li><li><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html">Using AWS CloudWatch Alarms</a></li><li><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html">CloudWatch Filter and Patten matching syntax</a></li><li><a href="https://docs.aws.amazon.com/firehose/latest/dev/monitoring-with-cloudwatch-metrics.html">Other Cloudwatch metrics for Kinesis Firehose</a></li></ol><span class="meta"><time datetime="2019-10-01T05:30:00+00:00">October 1, 2019</time> &middot; <a href="/tags/#aws">aws</a>, <a href="/tags/#kinesis">kinesis</a>, <a href="/tags/#cloudwatch">cloudwatch</a>, <a href="/tags/#monitoring">monitoring</a>, <a href="/tags/#redshift">redshift</a></span><hr> <!--<span class="meta"><time datetime="2019-10-01T05:30:00+00:00">October 1, 2019</time> &middot; <a class="post" href="/tag/aws">aws</a>, <a class="post" href="/tag/kinesis">kinesis</a>, <a class="post" href="/tag/cloudwatch">cloudwatch</a>, <a class="post" href="/tag/monitoring">monitoring</a>, <a class="post" href="/tag/redshift">redshift</a></span> --></section></main></body></html>
