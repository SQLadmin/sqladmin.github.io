<!DOCTYPE html><html lang="en" ><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="/assets/css/syntax.css" rel="stylesheet"><title>How GCP Browser Based SSH Works | The Data Guy</title><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="How GCP Browser Based SSH Works" /><meta name="author" content="Bhuvanesh" /><meta property="og:locale" content="en_US" /><meta name="description" content="A blog port that explains about how GCP browser based SSH works internally. You can access the VM without allowing your Public IP address." /><meta property="og:description" content="A blog port that explains about how GCP browser based SSH works internally. You can access the VM without allowing your Public IP address." /><meta property="og:site_name" content="The Data Guy" /><meta property="og:image" content="/assets/How%20GCP%20Browser%20Based%20SSH%20Works-cover.jpg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-10-01T18:32:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:image" content="/assets/How%20GCP%20Browser%20Based%20SSH%20Works-cover.jpg" /><meta property="twitter:title" content="How GCP Browser Based SSH Works" /><meta name="twitter:site" content="@bhuvithedataguy" /><meta name="twitter:creator" content="@https://twitter.com/BhuviTheDataGuy" /> <script type="application/ld+json"> {"dateModified":"2019-10-01T18:32:00+00:00","datePublished":"2019-10-01T18:32:00+00:00","image":"/assets/How%20GCP%20Browser%20Based%20SSH%20Works-cover.jpg","url":"/2019/10/01/how-gcp-browser-bases-ssh-works","mainEntityOfPage":{"@type":"WebPage","@id":"/2019/10/01/how-gcp-browser-bases-ssh-works"},"@type":"BlogPosting","author":{"@type":"Person","name":"Bhuvanesh"},"description":"A blog port that explains about how GCP browser based SSH works internally. You can access the VM without allowing your Public IP address.","headline":"How GCP Browser Based SSH Works","@context":"https://schema.org"}</script><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.7;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}#share-bar{font-size:20px}#share-bar h4{margin-bottom:10px;font-weight:500}.share-button{margin:0px;margin-bottom:10px;margin-right:3px;border:1px solid #D3D6D2;padding:5px 10px 5px 10px}.share-button:hover{opacity:1;color:#ffffff}.fa-facebook-official{color:#3b5998}.fa-facebook-official:hover{background-color:#3b5998}.fa-twitter{color:#55acee}.fa-twitter:hover{background-color:#55acee}.fa-google-plus{color:#dd4b39}.fa-google-plus:hover{background-color:#dd4b39}.fa-pinterest-p{color:#cb2027}.fa-pinterest-p:hover{background-color:#cb2027}.fa-tumblr{color:#32506d}.fa-tumblr:hover{background-color:#32506d}.fa-reddit-alien{color:#ff4500}.fa-reddit-alien:hover{background-color:#ff4500}.fa-linkedin{color:#007bb5}.fa-linkedin:hover{background-color:#007bb5}.fa-envelope{color:#444444}.fa-envelope:hover{background-color:#444444}</style></head><body><main role="main"><header role="banner"><h1 class="logo">The Data Guy</h1><div class="page-author h-card p-author"><img src="/assets/circle-cropped.png" class="author-avatar u-photo" alt="Bhuvanesh"></div><nav role="navigation"><ul><li><a href="/" >Home</a></li><li><a href="/posts/" >Posts</a></li><li><a href="/categories/" >Categories</a></li><li><a href="/tags/" >Tags</a></li><li><a href="https://medium.com/@bhuvithedataguy" >Medium Blog</a></li><li><a href="/search" >Search Here</a></li></ul></nav></header><section class="post"><h2>How GCP Browser Based SSH Works</h2><p>If you are using GCP platform and lazy to setup VPN or bastion host, then you may familiar with using SSH connection via a browser. Yeah, its just one click to login to the Linux VM. Here are some questions for you.</p><ol><li>How many of you think how this actually works in the backend?</li><li>Can we access the VM (via browser SSH) without whitelist our Public IP address in the firewall rule?</li><li>Why the VM is not accessible via Browser SSH even though we whitelisted our Public IP?</li></ol><p>I had a situation to dig deeper into understanding this concept.</p><h2 id="my-problematic-situation">My Problematic situation:</h2><p>I was launching a new VM in GCP and tagged with <code class="language-html highlighter-rouge">allow-office-ssh</code>. Then created a Firewall rule which allows <code class="language-html highlighter-rouge">Port 22</code> from the IP address <code class="language-html highlighter-rouge">X.X.X.X</code>(my office IP address) to the target tag <code class="language-html highlighter-rouge">allow-office-ssh</code>. Once the VM came to an active state, I tried to telnet on port 22. It was working fine.</p><p>But I don’t any username and password to login, So I thought to access the VM via browser then create the user. But unfortunately Im not able to access the VM via Browser. This made me go deep into this functionality.</p><h2 id="how-browser-ssh-works">How Browser SSH Works:</h2><p>Here is an illustration that I have in my mind how this actually works.</p><p><img src="/assets/How GCP Browser Based SSH Works.jpg" alt="" /></p><ol><li>There is no need to allow your IP Address in the firewall rule.</li><li>The communication is happening between the VM and Google’s SSH Proxy(i don’t know the right term, so Im using the term proxy).</li><li>Your browser is just talking to the Proxy layer.</li><li>The Proxy layer is actually talking to the VM.</li><li>Its more or less a port forwarding or SSH tunneling.</li></ol><h2 id="how-gcps-proxy-can-access-the-vm">How GCP’s proxy can access the VM?</h2><p>As per GCP’s security policy, no one can access the VM without allowing their IP address. Then how this proxy is accessing it?</p><p>There is no way to proxy to access the VM. But Google has some static IP ranges which are assigned to its proxy layer. By whitelisting that IP range, they can talk to your VM.</p><p><strong>From the GCP doc:</strong></p><blockquote><p>Source IP addresses for browser-based SSH sessions are dynamically allocated by GCP Console and can vary from session to session. For the feature to work, you must allow connections either from any IP address or from Google’s IP address range which you can retrieve using <a href="https://support.google.com/a/answer/60764">public SPF records</a>.</p></blockquote><p>If you run the below commands, you can get the IP address range for proxy layer.</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>nslookup -q=TXT _netblocks.google.com 8.8.8.8
nslookup -q=TXT _netblocks2.google.com 8.8.8.8
nslookup -q=TXT _netblocks3.google.com 8.8.8.8
</code></pre></div></div><p><strong>For eg:</strong></p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>nslookup -q=TXT _netblocks.google.com 8.8.8.8

Server:		8.8.8.8
Address:	8.8.8.8#53

Non-authoritative answer:
_netblocks.google.com	text = "v=spf1 ip4:35.190.247.0/24 ip4:64.233.160.0/19 ip4:66.102.0.0/20 ip4:66.249.80.0/20 ip4:72.14.192.0/18 ip4:74.125.0.0/16 ip4:108.177.8.0/21 ip4:173.194.0.0/16 ip4:209.85.128.0/17 ip4:216.58.192.0/19 ip4:216.239.32.0/19 ~all"

Authoritative answers can be found from:
</code></pre></div></div><p>You can see a bunch of Public IP address. Right now we have the following IP ranges for accessing the VM via the browser.</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>35.190.247.0/24
64.233.160.0/19
66.102.0.0/20
66.249.80.0/20
72.14.192.0/18
74.125.0.0/16
108.177.8.0/21
173.194.0.0/16
209.85.128.0/17
216.58.192.0/19
216.239.32.0/19
172.217.0.0/19
172.217.32.0/20
172.217.128.0/19
172.217.160.0/20
172.217.192.0/19
108.177.96.0/19
35.191.0.0/16
130.211.0.0/22
</code></pre></div></div><p>Once you create a firewall rule which allows Port 22 from the above IP addresses, then we can access the VM via browser. Hope you learned something new today.</p><h2 id="my-personal-suggestion">My Personal Suggestion:</h2><p>But I always recommend that do not use this for production. Because I had some nightmares because of this. The VM goes offline due to the <code class="language-html highlighter-rouge">live host migration</code>. After that, the services are not started. I tried to access it via browser. Unfortunately, that time GCP’s some services also down which establish the connection between the browser and the VM. So use VPN or bastion host for this.</p><p>Happy SSH !!!</p><span class="meta"><time datetime="2019-10-01T18:32:00+00:00">October 1, 2019</time> &middot; <a href="/tags/#gcp">gcp</a>, <a href="/tags/#ssh">ssh</a>, <a href="/tags/#security">security</a></span><hr> <!--<span class="meta"><time datetime="2019-10-01T18:32:00+00:00">October 1, 2019</time> &middot; <a class="post" href="/tag/gcp">gcp</a>, <a class="post" href="/tag/ssh">ssh</a>, <a class="post" href="/tag/security">security</a></span> --></section></main></body></html>
