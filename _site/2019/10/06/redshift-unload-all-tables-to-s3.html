<!DOCTYPE html><html lang="en" ><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="/assets/css/syntax.css" rel="stylesheet"><title>RedShift Unload All Tables To S3 | The Data Guy</title><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="RedShift Unload All Tables To S3" /><meta name="author" content="Bhuvanesh" /><meta property="og:locale" content="en_US" /><meta name="description" content="Easy way to export or unload all the tables to S3 from Redshift using stored procedure. Also it’ll export with partitions in S3" /><meta property="og:description" content="Easy way to export or unload all the tables to S3 from Redshift using stored procedure. Also it’ll export with partitions in S3" /><meta property="og:site_name" content="The Data Guy" /><meta property="og:image" content="/assets/RedShift%20Unload%20All%20Tables%20To%20S3.jpg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-10-06T19:40:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:image" content="/assets/RedShift%20Unload%20All%20Tables%20To%20S3.jpg" /><meta property="twitter:title" content="RedShift Unload All Tables To S3" /><meta name="twitter:site" content="@bhuvithedataguy" /><meta name="twitter:creator" content="@https://twitter.com/BhuviTheDataGuy" /> <script type="application/ld+json"> {"dateModified":"2019-10-06T19:40:00+00:00","datePublished":"2019-10-06T19:40:00+00:00","image":"/assets/RedShift%20Unload%20All%20Tables%20To%20S3.jpg","url":"/2019/10/06/redshift-unload-all-tables-to-s3","mainEntityOfPage":{"@type":"WebPage","@id":"/2019/10/06/redshift-unload-all-tables-to-s3"},"@type":"BlogPosting","author":{"@type":"Person","name":"Bhuvanesh"},"description":"Easy way to export or unload all the tables to S3 from Redshift using stored procedure. Also it’ll export with partitions in S3","headline":"RedShift Unload All Tables To S3","@context":"https://schema.org"}</script><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.7;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}#share-bar{font-size:20px}#share-bar h4{margin-bottom:10px;font-weight:500}.share-button{margin:0px;margin-bottom:10px;margin-right:3px;border:1px solid #D3D6D2;padding:5px 10px 5px 10px}.share-button:hover{opacity:1;color:#ffffff}.fa-facebook-official{color:#3b5998}.fa-facebook-official:hover{background-color:#3b5998}.fa-twitter{color:#55acee}.fa-twitter:hover{background-color:#55acee}.fa-google-plus{color:#dd4b39}.fa-google-plus:hover{background-color:#dd4b39}.fa-pinterest-p{color:#cb2027}.fa-pinterest-p:hover{background-color:#cb2027}.fa-tumblr{color:#32506d}.fa-tumblr:hover{background-color:#32506d}.fa-reddit-alien{color:#ff4500}.fa-reddit-alien:hover{background-color:#ff4500}.fa-linkedin{color:#007bb5}.fa-linkedin:hover{background-color:#007bb5}.fa-envelope{color:#444444}.fa-envelope:hover{background-color:#444444}</style></head><body><main role="main"><header role="banner"><h1 class="logo">The Data Guy</h1><div class="page-author h-card p-author"><img src="/assets/circle-cropped.png" class="author-avatar u-photo" alt="Bhuvanesh"></div><nav role="navigation"><ul><li><a href="/" >Home</a></li><li><a href="/posts/" >Posts</a></li><li><a href="/categories/" >Categories</a></li><li><a href="/tags/" >Tags</a></li><li><a href="https://medium.com/@bhuvithedataguy" >Medium Blog</a></li><li><a href="/search" >Search Here</a></li></ul></nav></header><section class="post"><h2>RedShift Unload All Tables To S3</h2><p>RedShift <code class="language-html highlighter-rouge">unload</code> function will help us to export/unload the data from the tables to S3 directly. It actually runs a select query to get the results and them store them into S3. But unfortunately, it supports only one table at a time. You need to create a script to get the all the tables then store it in a variable, and loop the unload query with the list of tables. Here I have done with PL/SQL way to handle this. You can Export/Unload all the tables to S3 with partitions.</p><p>If you didn’t take a look at how to export a table with Partition and why? Please <a href="https://thedataguy.in/redshift-unload-to-s3-with-partitions-stored-procedure-way/">hit here</a> and read about the importance of it.</p><h2 id="why-this-procedure-actually-doing">Why this procedure actually doing?</h2><ol><li>It will get the list of schema and table in your database from the <code class="language-html highlighter-rouge">information_schema</code>.</li><li>Store this information in a variable.</li><li>IAM role, Partitions are hardcoded, you can customize it or pass them in a variable.</li><li>A <code class="language-html highlighter-rouge">FOR LOOP</code> will run the unload query for all the tables.</li></ol><h2 id="variables">Variables:</h2><ul><li>list - list of schema and table names in the database.</li><li>db - Current connected database name.</li><li>tablename - table name (used for history table only).</li><li>tableschema - table schema (used for history table only).</li><li>starttime - When the unload the process stated.</li><li>endtime - When the unload process end.</li><li>SQL - its a <code class="language-html highlighter-rouge">select * from</code>, but if you want to change like <code class="language-html highlighter-rouge">where timestamp &gt;= something</code> you can customize this variable.</li><li>s3_path - Location of S3, you need to pass this variable while executing the procedure.</li><li>iamrole - IAM role to write into the S3 bucket.</li><li>delimiter - Delimiter for the file.</li><li>max_filesize - Redshift will split your files in S3 in random sizes, you can mention a size for the files.</li><li>un_year, un_month, un_day - Current Year, month, day</li><li>unload_query - Dynamically generate the unload query.</li><li>unload_id - This is for maintaining the history purpose, In one shot you can export all the tables, from this ID, you can get the list of tables uploaded from a particular export operation.</li><li>unload_time - Timestamp of when you started executing the procedure.</li></ul><blockquote><p><strong>NOTE</strong>: This stored procedure and the history table needs to installed on all the databases. Because from information schema it’ll only return the list of tables in the current schema. Its Redshift’s limitation.</p></blockquote><h3 id="update-2019-10-08">Update 2019-10-08</h3><p>I have made a small change here, the stored procedure will generate the COPY command as well. You can query the <code class="language-html highlighter-rouge">unload_history</code> table to get the COPY command for a particular table. So you can easily import the data into any RedShift clusters.</p><h3 id="update-2019-11-22">Update 2019-11-22</h3><p>I have published a new blog. You can now export based on your requirements like export only few tables, all tables in a schema, all tables in multiple schema and etc. Click on the below link. <a href="https://thedataguy.in/redshift-unload-multiple-tables-schema-to-s3/">https://thedataguy.in/redshift-unload-multiple-tables-schema-to-s3/</a></p><h2 id="table-for-maintaining-the-history-of-unload">Table for maintaining the History of Unload:</h2><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">unload_history</span>
<span class="p">(</span>
<span class="n">pid</span>          <span class="nb">INT</span> <span class="k">IDENTITY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">u_id</span>         <span class="nb">INT</span><span class="p">,</span>
<span class="n">u_timestamp</span>  <span class="nb">DATETIME</span><span class="p">,</span>
<span class="n">start_time</span>   <span class="nb">DATETIME</span><span class="p">,</span>
<span class="n">end_time</span>     <span class="nb">DATETIME</span><span class="p">,</span>
<span class="n">db_name</span>      <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="n">table_schema</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="k">table_name</span>   <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="n">export_query</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">65000</span><span class="p">),</span>
<span class="n">import_query</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">65000</span><span class="p">)</span>
<span class="p">);</span></code></pre></figure><h2 id="stored-procedure">Stored Procedure:</h2><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">replace</span> <span class="k">PROCEDURE</span> <span class="n">unload_all</span><span class="p">(</span><span class="n">s3_location</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">10000</span><span class="p">))</span> <span class="k">LANGUAGE</span> <span class="n">plpgsql</span>
<span class="k">AS</span>
<span class="err">$$</span>
<span class="k">DECLARE</span>
<span class="n">list</span> <span class="n">RECORD</span><span class="p">;</span>
<span class="n">db</span>        <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="n">tablename</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="n">tableschema</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="n">starttime</span> <span class="nb">datetime</span><span class="p">;</span>
<span class="n">endtime</span>   <span class="nb">datetime</span><span class="p">;</span>
<span class="k">SQL</span> <span class="nb">text</span><span class="p">;</span>
<span class="n">s3_path</span>      <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="n">iamrole</span>      <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="k">delimiter</span>    <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="n">max_filesize</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="n">un_year</span>      <span class="nb">INT</span><span class="p">;</span>
<span class="n">un_month</span>     <span class="nb">INT</span><span class="p">;</span>
<span class="n">un_day</span>       <span class="nb">INT</span><span class="p">;</span>
<span class="n">unload_query</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">65000</span><span class="p">);</span>
<span class="n">copy_query</span>   <span class="nb">varchar</span><span class="p">(</span><span class="mi">65000</span><span class="p">);</span>
<span class="n">unload_id</span> <span class="nb">INT</span><span class="p">;</span>
<span class="n">unload_time</span> <span class="nb">timestamp</span><span class="p">;</span>

      <span class="k">BEGIN</span> 
      
        <span class="c1">-- Pass values for the variables </span>
        <span class="k">SELECT</span> <span class="k">extract</span><span class="p">(</span><span class="nb">year</span> <span class="k">FROM</span> <span class="n">getdate</span><span class="p">())</span> 
        <span class="k">INTO</span>   <span class="n">un_year</span><span class="p">;</span> 
         
        <span class="k">SELECT</span> <span class="k">extract</span><span class="p">(</span><span class="k">month</span> <span class="k">FROM</span> <span class="n">getdate</span><span class="p">())</span> 
        <span class="k">INTO</span>   <span class="n">un_month</span><span class="p">;</span> 
         
        <span class="k">SELECT</span> <span class="k">extract</span><span class="p">(</span><span class="k">day</span> <span class="k">FROM</span> <span class="n">getdate</span><span class="p">())</span> 
        <span class="k">INTO</span>   <span class="n">un_day</span><span class="p">;</span> 
         
        <span class="k">SELECT</span> <span class="k">DISTINCT</span><span class="p">(</span><span class="n">table_catalog</span><span class="p">)</span> 
        <span class="k">FROM</span>            <span class="n">information_schema</span><span class="p">.</span><span class="n">TABLES</span> 
        <span class="k">INTO</span>            <span class="n">db</span><span class="p">;</span> 
         
        <span class="k">SELECT</span> <span class="n">coalesce</span><span class="p">(</span><span class="k">max</span><span class="p">(</span><span class="n">u_id</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span> 
        <span class="k">FROM</span>   <span class="n">unload_history</span> 
        <span class="k">INTO</span>   <span class="n">unload_id</span><span class="p">;</span> 
         
        <span class="k">SELECT</span> <span class="n">getdate</span><span class="p">()</span> 
        <span class="k">INTO</span>   <span class="n">unload_time</span><span class="p">;</span> 
         
        <span class="n">s3_path</span><span class="p">:</span><span class="o">=</span><span class="n">s3_location</span><span class="p">;</span> 
        
        <span class="c1">-- IAM ROLE and the Delimiter is hardcoded here</span>
        <span class="n">iamrole</span><span class="p">:</span><span class="o">=</span><span class="s1">'arn:aws:iam::123123123:role/myredshiftrole'</span><span class="p">;</span> 
        <span class="k">delimiter</span><span class="p">:</span><span class="o">=</span><span class="s1">'|'</span><span class="p">;</span> 
        
        <span class="c1">-- Get the list of tables except the unload history table</span>
        <span class="k">FOR</span> <span class="n">list</span> <span class="k">IN</span> 
        <span class="k">SELECT</span> <span class="n">table_schema</span><span class="p">,</span> 
               <span class="k">table_name</span> 
        <span class="k">FROM</span>   <span class="n">information_schema</span><span class="p">.</span><span class="n">TABLES</span> 
        <span class="k">WHERE</span>  <span class="n">table_type</span><span class="o">=</span><span class="s1">'BASE TABLE'</span> 
        <span class="k">AND</span>    <span class="n">table_schema</span> <span class="k">NOT</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'pg_catalog'</span><span class="p">,</span> 
                                    <span class="s1">'information_schema'</span><span class="p">)</span> 
        <span class="k">AND</span>    <span class="k">table_name</span> <span class="o">!=</span><span class="s1">'unload_history'</span> <span class="n">LOOP</span> 
        
        <span class="k">SELECT</span> <span class="n">getdate</span><span class="p">()</span> 
        <span class="k">INTO</span>   <span class="n">starttime</span><span class="p">;</span> 
         
        <span class="k">sql</span><span class="p">:</span><span class="o">=</span><span class="s1">'select * from '</span><span class="o">||</span><span class="n">list</span><span class="p">.</span><span class="n">table_schema</span><span class="o">||</span><span class="s1">'.'</span><span class="o">||</span><span class="n">list</span><span class="p">.</span><span class="k">table_name</span><span class="o">||</span><span class="s1">''</span> <span class="p">;</span>
    
        <span class="n">RAISE</span> <span class="n">info</span> <span class="s1">'[%] Unloading... schema = % and table = %'</span><span class="p">,</span><span class="n">starttime</span><span class="p">,</span> <span class="n">list</span><span class="p">.</span><span class="n">table_schema</span><span class="p">,</span> <span class="n">list</span><span class="p">.</span><span class="k">table_name</span><span class="p">;</span>
        
        <span class="c1">-- Start unloading the data </span>
        <span class="n">unload_query</span> <span class="p">:</span><span class="o">=</span> <span class="s1">'unload (</span><span class="se">''</span><span class="s1">'</span><span class="o">||</span><span class="k">sql</span><span class="o">||</span><span class="s1">'</span><span class="se">''</span><span class="s1">) to </span><span class="se">''</span><span class="s1">'</span><span class="o">||</span><span class="n">s3_path</span><span class="o">||</span><span class="n">un_year</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_month</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_day</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">db</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">list</span><span class="p">.</span><span class="n">table_schema</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">list</span><span class="p">.</span><span class="k">table_name</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">list</span><span class="p">.</span><span class="n">table_schema</span><span class="o">||</span><span class="s1">'-'</span><span class="o">||</span><span class="n">list</span><span class="p">.</span><span class="k">table_name</span><span class="o">||</span><span class="s1">'_</span><span class="se">''</span><span class="s1"> iam_role </span><span class="se">''</span><span class="s1">'</span><span class="o">||</span><span class="n">iamrole</span><span class="o">||</span><span class="s1">'</span><span class="se">''</span><span class="s1"> delimiter </span><span class="se">''</span><span class="s1">'</span><span class="o">||</span><span class="k">delimiter</span><span class="o">||</span><span class="s1">'</span><span class="se">''</span><span class="s1"> MAXFILESIZE 300 MB PARALLEL ADDQUOTES HEADER GZIP'</span><span class="p">;</span>
        <span class="k">EXECUTE</span> <span class="n">unload_query</span><span class="p">;</span> 
        
        <span class="n">copy_query</span> <span class="p">:</span><span class="o">=</span> <span class="s1">'copy '</span><span class="o">||</span><span class="n">list</span><span class="p">.</span><span class="n">table_schema</span><span class="o">||</span><span class="s1">'.'</span><span class="o">||</span><span class="n">list</span><span class="p">.</span><span class="k">table_name</span><span class="o">||</span><span class="s1">' from </span><span class="se">''</span><span class="s1">'</span><span class="o">||</span><span class="n">s3_path</span><span class="o">||</span><span class="n">un_year</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_month</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_day</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">db</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">list</span><span class="p">.</span><span class="n">table_schema</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">list</span><span class="p">.</span><span class="k">table_name</span><span class="o">||</span><span class="s1">'/</span><span class="se">''</span><span class="s1"> iam_role </span><span class="se">''</span><span class="s1">'</span><span class="o">||</span><span class="n">iamrole</span><span class="o">||</span><span class="s1">'</span><span class="se">''</span><span class="s1"> delimiter </span><span class="se">''</span><span class="s1">'</span><span class="o">||</span><span class="k">delimiter</span><span class="o">||</span><span class="s1">'</span><span class="se">''</span><span class="s1"> IGNOREHEADER 1 REMOVEQUOTES gzip'</span><span class="p">;</span>
        
        <span class="k">SELECT</span> <span class="n">getdate</span><span class="p">()</span> 
        <span class="k">INTO</span>   <span class="n">endtime</span><span class="p">;</span> 
    
        <span class="k">SELECT</span> <span class="n">list</span><span class="p">.</span><span class="n">table_schema</span> 
        <span class="k">INTO</span> <span class="n">tableschema</span><span class="p">;</span>
    
        <span class="k">SELECT</span> <span class="n">list</span><span class="p">.</span><span class="k">table_name</span> 
        <span class="k">INTO</span> <span class="n">tablename</span><span class="p">;</span>
         
        <span class="c1">-- Insert into the history table</span>
        <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">unload_history</span> 
                    <span class="p">(</span> 
                                <span class="n">u_id</span><span class="p">,</span> 
                                <span class="n">u_timestamp</span><span class="p">,</span> 
                                <span class="n">start_time</span><span class="p">,</span> 
                                <span class="n">end_time</span><span class="p">,</span> 
                                <span class="n">db_name</span><span class="p">,</span> 
                                <span class="n">table_schema</span><span class="p">,</span>
                                <span class="k">table_name</span><span class="p">,</span>
                                <span class="n">export_query</span><span class="p">,</span>
                                <span class="n">import_query</span> 
                    <span class="p">)</span> 
                    <span class="k">VALUES</span> 
                    <span class="p">(</span> 
                                <span class="n">unload_id</span><span class="p">,</span> 
                                <span class="n">unload_time</span><span class="p">,</span> 
                                <span class="n">starttime</span><span class="p">,</span> 
                                <span class="n">endtime</span><span class="p">,</span> 
                                <span class="n">db</span><span class="p">,</span> 
                                <span class="n">tableschema</span><span class="p">,</span>
                                <span class="n">tablename</span><span class="p">,</span>
                                <span class="n">unload_query</span><span class="p">,</span>
                                <span class="n">copy_query</span>

                    <span class="p">);</span> 
       
      <span class="k">END</span> <span class="n">LOOP</span><span class="p">;</span> 
      <span class="n">RAISE</span> <span class="n">info</span> <span class="s1">' Unloading of the DB [%] is success !!!'</span> <span class="p">,</span><span class="n">db</span><span class="p">;</span>
    <span class="k">END</span><span class="p">;</span> 
    <span class="err">$$</span><span class="p">;</span></code></pre></figure><h2 id="hardcoded-items">Hardcoded Items:</h2><p>In the stored procedure, I have hardcoded the follow parameters.</p><ul><li>IAM ROLE - <code class="language-html highlighter-rouge">arn:aws:iam::123123123123:role/myredshiftrole</code></li><li>Delimiter - <code class="language-html highlighter-rouge">|</code></li></ul><p>Also, the following Items are hardcoded in the Unload query. You can get these things as variable or hardcoded as per your convenient.</p><ul><li>MAXFILESIZE - 100 MB</li><li>PARALLEL</li><li>ADDQUOTES</li><li>HEADER</li><li>GZIP</li></ul><h2 id="execute-the-procedure">Execute the procedure:</h2><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>call unload_all('s3://bhuvi-datalake/test/');
</code></pre></div></div><p>You can see the status in the terminal</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>INFO:  [2019-10-06 19:20:04] Unloading... schema = etl and table = tbl1
INFO:  UNLOAD completed, 2 record(s) unloaded successfully.
INFO:  [2019-10-06 19:20:10] Unloading... schema = etl and table = tbl2
INFO:  UNLOAD completed, 2 record(s) unloaded successfully.
INFO:  [2019-10-06 19:20:12] Unloading... schema = stage and table = tbl3
INFO:  UNLOAD completed, 2 record(s) unloaded successfully.
INFO:  [2019-10-06 19:20:12] Unloading... schema = stage and table = tbl4
INFO:  UNLOAD completed, 2 record(s) unloaded successfully.
INFO:  [2019-10-06 19:20:14] Unloading... schema = stage and table = tbl5
INFO:  UNLOAD completed, 2 record(s) unloaded successfully.
INFO:  [2019-10-06 19:20:15] Unloading... schema = prod and table = tbl6
INFO:  UNLOAD completed, 2 record(s) unloaded successfully.
INFO:  [2019-10-06 19:20:15] Unloading... schema = prod and table = tbl7
INFO:  UNLOAD completed, 2 record(s) unloaded successfully.
INFO:  [2019-10-06 19:20:15] Unloading... schema = public and table = debug
INFO:  UNLOAD completed, 0 record(s) unloaded successfully.
INFO:  [2019-10-06 19:20:16] Unloading... schema = public and table = test
INFO:  UNLOAD completed, 1 record(s) unloaded successfully.
INFO:   Unloading of the DB [preprod] is success !!!
CALL
</code></pre></div></div><h2 id="files-on-s3">Files on S3:</h2><p><img src="/assets/RedShift Unload All Tables To S3_1.jpg" alt="" /></p><p><img src="/assets/RedShift Unload All Tables To S3_2.jpg" alt="" /></p><h2 id="retrieve-the-history">Retrieve the History:</h2><figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">preprod</span><span class="o">=#</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">unload_history</span> <span class="k">limit</span> <span class="mi">1</span><span class="p">;</span>
    
<span class="n">pid</span>          <span class="o">|</span> <span class="mi">28</span>
<span class="n">u_id</span>         <span class="o">|</span> <span class="mi">1</span>
<span class="n">u_timestamp</span>  <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">08</span> <span class="mi">10</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">23</span>
<span class="n">start_time</span>   <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">08</span> <span class="mi">10</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">23</span>
<span class="n">end_time</span>     <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">08</span> <span class="mi">10</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">23</span>
<span class="n">db_name</span>      <span class="o">|</span> <span class="n">preprod</span>
<span class="n">table_schema</span> <span class="o">|</span> <span class="n">etl</span>
<span class="k">table_name</span>   <span class="o">|</span> <span class="n">tbl2</span>
<span class="n">export_query</span> <span class="o">|</span> <span class="n">unload</span> <span class="p">(</span><span class="s1">'select * from etl.tbl2'</span><span class="p">)</span> <span class="k">to</span> <span class="s1">'s3://bhuvi-datalake/test/2019/10/8/preprod/etl/tbl2/etl-tbl2_'</span> <span class="n">iam_role</span> <span class="s1">'arn:aws:iam::123123123:role/myredshiftrole'</span> <span class="k">delimiter</span> <span class="s1">'|'</span> <span class="n">MAXFILESIZE</span> <span class="mi">300</span> <span class="n">MB</span> <span class="n">PARALLEL</span> <span class="n">ADDQUOTES</span> <span class="n">HEADER</span> <span class="n">GZIP</span>
<span class="n">import_query</span> <span class="o">|</span> <span class="k">copy</span> <span class="n">etl</span><span class="p">.</span><span class="n">tbl2</span> <span class="k">from</span> <span class="s1">'s3://bhuvi-datalake/test/2019/10/8/preprod/etl/tbl2/'</span> <span class="n">iam_role</span> <span class="s1">'arn:aws:iam::123123123:role/myredshiftrole'</span> <span class="k">delimiter</span> <span class="s1">'|'</span> <span class="n">IGNOREHEADER</span> <span class="mi">1</span> <span class="n">REMOVEQUOTES</span> <span class="n">gzip</span></code></pre></figure><span class="meta"><time datetime="2019-10-06T19:40:00+00:00">October 6, 2019</time> &middot; <a href="/tags/#aws">aws</a>, <a href="/tags/#redshift">redshift</a>, <a href="/tags/#s3">s3</a>, <a href="/tags/#sql">sql</a></span><hr> <!--<span class="meta"><time datetime="2019-10-06T19:40:00+00:00">October 6, 2019</time> &middot; <a class="post" href="/tag/aws">aws</a>, <a class="post" href="/tag/redshift">redshift</a>, <a class="post" href="/tag/s3">s3</a>, <a class="post" href="/tag/sql">sql</a></span> --></section></main></body></html>
