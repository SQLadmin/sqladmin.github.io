<!DOCTYPE html><html lang="en" ><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="/assets/css/syntax.css" rel="stylesheet"><title>Relationalize Unstructured Data In AWS Athena with GrokSerDe | The Data Guy</title><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="Relationalize Unstructured Data In AWS Athena with GrokSerDe" /><meta name="author" content="Bhuvanesh" /><meta property="og:locale" content="en_US" /><meta name="description" content="We can relationalize unstructured data like syslog, SQL Server error log or cloudwatch export in AWS Athena with GrokSerDe." /><meta property="og:description" content="We can relationalize unstructured data like syslog, SQL Server error log or cloudwatch export in AWS Athena with GrokSerDe." /><meta property="og:site_name" content="The Data Guy" /><meta property="og:image" content="/assets/Relationalize%20Unstructured%20Data%20In%20AWS%20Athena%20with%20GrokSerDe.jpg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-09-22T18:30:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:image" content="/assets/Relationalize%20Unstructured%20Data%20In%20AWS%20Athena%20with%20GrokSerDe.jpg" /><meta property="twitter:title" content="Relationalize Unstructured Data In AWS Athena with GrokSerDe" /><meta name="twitter:site" content="@bhuvithedataguy" /><meta name="twitter:creator" content="@https://twitter.com/BhuviTheDataGuy" /> <script type="application/ld+json"> {"dateModified":"2019-09-22T18:30:00+00:00","datePublished":"2019-09-22T18:30:00+00:00","image":"/assets/Relationalize%20Unstructured%20Data%20In%20AWS%20Athena%20with%20GrokSerDe.jpg","url":"/2019/09/22/relationalize-unstructured-data-in-aws-athena-with-grokserde","mainEntityOfPage":{"@type":"WebPage","@id":"/2019/09/22/relationalize-unstructured-data-in-aws-athena-with-grokserde"},"@type":"BlogPosting","author":{"@type":"Person","name":"Bhuvanesh"},"description":"We can relationalize unstructured data like syslog, SQL Server error log or cloudwatch export in AWS Athena with GrokSerDe.","headline":"Relationalize Unstructured Data In AWS Athena with GrokSerDe","@context":"https://schema.org"}</script><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.7;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}#share-bar{font-size:20px}#share-bar h4{margin-bottom:10px;font-weight:500}.share-button{margin:0px;margin-bottom:10px;margin-right:3px;border:1px solid #D3D6D2;padding:5px 10px 5px 10px}.share-button:hover{opacity:1;color:#ffffff}.fa-facebook-official{color:#3b5998}.fa-facebook-official:hover{background-color:#3b5998}.fa-twitter{color:#55acee}.fa-twitter:hover{background-color:#55acee}.fa-google-plus{color:#dd4b39}.fa-google-plus:hover{background-color:#dd4b39}.fa-pinterest-p{color:#cb2027}.fa-pinterest-p:hover{background-color:#cb2027}.fa-tumblr{color:#32506d}.fa-tumblr:hover{background-color:#32506d}.fa-reddit-alien{color:#ff4500}.fa-reddit-alien:hover{background-color:#ff4500}.fa-linkedin{color:#007bb5}.fa-linkedin:hover{background-color:#007bb5}.fa-envelope{color:#444444}.fa-envelope:hover{background-color:#444444}</style></head><body><main role="main"><header role="banner"><h1 class="logo">The Data Guy</h1><div class="page-author h-card p-author"><img src="/assets/circle-cropped.png" class="author-avatar u-photo" alt="Bhuvanesh"></div><nav role="navigation"><ul><li><a href="/" >Home</a></li><li><a href="/posts/" >Posts</a></li><li><a href="/categories/" >Categories</a></li><li><a href="/tags/" >Tags</a></li><li><a href="https://medium.com/@bhuvithedataguy" >Medium Blog</a></li><li><a href="/search" >Search Here</a></li></ul></nav></header><section class="post"><h2>Relationalize Unstructured Data In AWS Athena with GrokSerDe</h2><p>Managing the logs in a centralized repository is one of the most common best practices in the DevOps world. Application logs, system logs, error logs, and any databases logs also will be pushed into your centralized repository. You can use ELK stack or Splunk to visualize the logs to get better insights about it. But as a SQL guy, I wanted to solve this problem with Bigdata ecosystem(use SQL). As a part of that process, we can relationalize unstructured data in AWS Athena with the help of GrokSerDe.</p><p>Here S3 is my centralized repository. I know it will not scale like ElasticSearch, but why should I miss this Fun. For this use case, Im going to rationalize the SQL Server Error log in AWS Athena. Let’s take a look at the SQL server’s error log pattern.</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>2019-09-21 12:53:17.57 Server      UTC adjustment: 0:00
2019-09-21 12:53:17.57 Server      (c) Microsoft Corporation.
2019-09-21 12:53:17.57 Server      All rights reserved.
2019-09-21 12:53:17.57 Server      Server process ID is 4152.
</code></pre></div></div><p>Its looks like</p><p><code class="language-html highlighter-rouge">yyyy-mm-dd</code> space <code class="language-html highlighter-rouge">hh:mm:ss:ms</code> space <code class="language-html highlighter-rouge">User</code> space <code class="language-html highlighter-rouge">message</code></p><p>But sometimes, it has many lines like below.</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>2019-09-21 12:53:17.57 Server      Microsoft SQL Server 2017 (RTM) - 14.0.1000.169 (X64) 
  Aug 22 2017 17:04:49 
  Copyright (C) 2017 Microsoft Corporation
  Enterprise Edition: Core-based Licensing (64-bit) on Windows Server 2016 Datacenter 10.0 <span class="nt">&lt;X64&gt;</span> (Build 14393: ) (Hypervisor)
2019-09-21 12:53:17.57 Server      UTC adjustment: 0:00
2019-09-21 12:53:17.57 Server      (c) Microsoft Corporation.
</code></pre></div></div><p>If you see the 2nd, 3rd line we have the only message. And we know these all are just for information purpose, we’ll not get any useful information with that. Also as a part of Data cleansing, we should clean up some unwanted lines to make this relationalize.</p><p>I can consider the below format for my relationalize structure.</p><ul><li>Year - Integer</li><li>Month - Integer</li><li>Day - Integer</li><li>Hour - Integer</li><li>Minute - Integer</li><li>Second - Integer</li><li>User - String</li><li>Message - String</li></ul><p><strong>We can convert this into a Grok pattern for this.</strong></p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>%{YEAR:year}-%{MONTHNUM:month}-%{MONTHDAY:day}\\s*%{TIME:time} %{LOG_LEVEL:user}\\s*( )*%{GREEDYDATA:message}
</code></pre></div></div><h2 id="create-the-table-in-athena">Create the table in Athena:</h2><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>CREATE EXTERNAL TABLE `sql_errorlog`(
  `year` string , 
  `month` string , 
  `day` string , 
  `time` string , 
  `user` string , 
  `message` string )  
ROW FORMAT SERDE 
  'com.amazonaws.glue.serde.GrokSerDe' 
WITH SERDEPROPERTIES ( 
  'input.format'='%{YEAR:year}-%{MONTHNUM:month}-%{MONTHDAY:day}\\s*%{TIME:time} %{LOG_LEVEL:user}\\s*( )*%{GREEDYDATA:message}', 
'input.grokCustomPatterns'='LOG_LEVEL \[a-zA-Z0-9\]*') 
STORED AS INPUTFORMAT 
  'org.apache.hadoop.mapred.TextInputFormat' 
OUTPUTFORMAT 
  'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'
LOCATION
  's3://bhuvi-datalake/sql-error-log/'
</code></pre></div></div><p>The table got created. I used a custom pattern for pulling the user column.</p><h2 id="query-the-data">Query the data:</h2><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>SELECT *
FROM "default"."sql_errorlog" limit 10;
</code></pre></div></div><p><img src="/assets/Relationalize Unstructured Data In AWS Athena with GrokSerDe-1.jpg" alt="" /></p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>SELECT *
FROM "default"."sql_errorlog"
WHERE message LIKE '%shutdown%';
</code></pre></div></div><p><img src="/assets/Relationalize Unstructured Data In AWS Athena with GrokSerDe-2.jpg" alt="" /></p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>SELECT *
FROM "default"."sql_errorlog"
WHERE message LIKE '%Login failed%'
</code></pre></div></div><p><img src="/assets/Relationalize Unstructured Data In AWS Athena with GrokSerDe-3.jpg" alt="" /></p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>SELECT concat ('Server started at: ',year,'-',month,'-',day,' ',time) AS StartupTime
FROM "default"."sql_errorlog"
WHERE message LIKE '%Server process ID is%';
</code></pre></div></div><p><img src="/assets/Relationalize Unstructured Data In AWS Athena with GrokSerDe-4.jpg" alt="" /></p><p>This is just a beginner guide, you can play around with windows logs, linux syslog, if you are a DBA then you may like to use this for MySQL, PostgreSQL, MongoDB logs.</p><h2 id="bonus-regex-serde">BONUS: Regex Serde</h2><p>If you are a developer, then regex might be easy for you. You can create a table with Regex Serde. Thanks to LeftJoin <a href="https://stackoverflow.com/users/2700344/leftjoin">Who helped to write this Regex</a></p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>CREATE EXTERNAL TABLE `bhuvi`(
  `date` string , 
  `time` string , 
  `user` string , 
  `message` string )
ROW FORMAT SERDE 
  'org.apache.hadoop.hive.serde2.RegexSerDe' 
WITH SERDEPROPERTIES ( 
  'input.regex'='(.*\\-.*\\-.*)\\s+(\\d+:\\d+:\\d+.\\d+)\\s+(\\S+)\\s+(.*?)$') 
STORED AS INPUTFORMAT 
  'org.apache.hadoop.mapred.TextInputFormat' 
OUTPUTFORMAT 
  'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'
LOCATION
  's3://bhuvi-datalake/bhuvi-1/'
</code></pre></div></div><p><img src="/assets/Relationalize Unstructured Data In AWS Athena with GrokSerDe-5.jpg" alt="" /></p><h2 id="references">References:</h2><ol><li><a href="https://aws.amazon.com/blogs/database/monitor-your-microsoft-sql-server-using-custom-metrics-with-amazon-cloudwatch-and-aws-systems-manager/">Manage the SQL server workload with Customer Cloudwatch metrics.</a></li><li><a href="https://docs.aws.amazon.com/athena/latest/ug/grok.html">AWS Athena Grok Serde.</a></li></ol><span class="meta"><time datetime="2019-09-22T18:30:00+00:00">September 22, 2019</time> &middot; <a href="/tags/#aws">aws</a>, <a href="/tags/#athena">athena</a>, <a href="/tags/#bigdata">bigdata</a>, <a href="/tags/#Grok">Grok</a></span><hr> <!--<span class="meta"><time datetime="2019-09-22T18:30:00+00:00">September 22, 2019</time> &middot; <a class="post" href="/tag/aws">aws</a>, <a class="post" href="/tag/athena">athena</a>, <a class="post" href="/tag/bigdata">bigdata</a>, <a class="post" href="/tag/Grok">Grok</a></span> --></section></main></body></html>
