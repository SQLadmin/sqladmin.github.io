<!DOCTYPE html><html lang="en" ><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="/assets/css/syntax.css" rel="stylesheet"><title>MySQL Convert Binlog Based Replication To GTID Replication Without Downtime | The Data Guy</title><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="MySQL Convert Binlog Based Replication To GTID Replication Without Downtime" /><meta name="author" content="Bhuvanesh" /><meta property="og:locale" content="en_US" /><meta name="description" content="MySQL using binlog file and position for replication. For setting up GTID based replication we need to use master_auto_position is 1." /><meta property="og:description" content="MySQL using binlog file and position for replication. For setting up GTID based replication we need to use master_auto_position is 1." /><meta property="og:site_name" content="The Data Guy" /><meta property="og:image" content="/assets/MySQL%20Convert%20Binlog%20Based%20Replication%20To%20GTID%20Replication%20Without%20Downtime-cover.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-08-24T07:58:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:image" content="/assets/MySQL%20Convert%20Binlog%20Based%20Replication%20To%20GTID%20Replication%20Without%20Downtime-cover.png" /><meta property="twitter:title" content="MySQL Convert Binlog Based Replication To GTID Replication Without Downtime" /><meta name="twitter:site" content="@bhuvithedataguy" /><meta name="twitter:creator" content="@https://twitter.com/BhuviTheDataGuy" /> <script type="application/ld+json"> {"dateModified":"2019-08-24T07:58:00+00:00","datePublished":"2019-08-24T07:58:00+00:00","image":"/assets/MySQL%20Convert%20Binlog%20Based%20Replication%20To%20GTID%20Replication%20Without%20Downtime-cover.png","url":"/2019/08/24/mysql-convert-binlog-based-replication-to-gtid-replication-without-downtime","mainEntityOfPage":{"@type":"WebPage","@id":"/2019/08/24/mysql-convert-binlog-based-replication-to-gtid-replication-without-downtime"},"@type":"BlogPosting","author":{"@type":"Person","name":"Bhuvanesh"},"description":"MySQL using binlog file and position for replication. For setting up GTID based replication we need to use master_auto_position is 1.","headline":"MySQL Convert Binlog Based Replication To GTID Replication Without Downtime","@context":"https://schema.org"}</script><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.7;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}#share-bar{font-size:20px}#share-bar h4{margin-bottom:10px;font-weight:500}.share-button{margin:0px;margin-bottom:10px;margin-right:3px;border:1px solid #D3D6D2;padding:5px 10px 5px 10px}.share-button:hover{opacity:1;color:#ffffff}.fa-facebook-official{color:#3b5998}.fa-facebook-official:hover{background-color:#3b5998}.fa-twitter{color:#55acee}.fa-twitter:hover{background-color:#55acee}.fa-google-plus{color:#dd4b39}.fa-google-plus:hover{background-color:#dd4b39}.fa-pinterest-p{color:#cb2027}.fa-pinterest-p:hover{background-color:#cb2027}.fa-tumblr{color:#32506d}.fa-tumblr:hover{background-color:#32506d}.fa-reddit-alien{color:#ff4500}.fa-reddit-alien:hover{background-color:#ff4500}.fa-linkedin{color:#007bb5}.fa-linkedin:hover{background-color:#007bb5}.fa-envelope{color:#444444}.fa-envelope:hover{background-color:#444444}</style></head><body><main role="main"><header role="banner"><h1 class="logo">The Data Guy</h1><div class="page-author h-card p-author"><img src="/assets/circle-cropped.png" class="author-avatar u-photo" alt="Bhuvanesh"></div><nav role="navigation"><ul><li><a href="/" >Home</a></li><li><a href="/posts/" >Posts</a></li><li><a href="/categories/" >Categories</a></li><li><a href="/tags/" >Tags</a></li><li><a href="https://medium.com/@bhuvithedataguy" >Medium Blog</a></li><li><a href="/search" >Search Here</a></li></ul></nav></header><section class="post"><h2>MySQL Convert Binlog Based Replication To GTID Replication Without Downtime</h2><p>This title may be suitable for the new age MySQL Users. Because in 5.7 onwards its already supported to enable GTID online. But still few of my mission critical databases are in 5.6 and handling <code class="language-html highlighter-rouge">70k QPS</code>. So I know enabling GTID needs downtime for this. But in my case, the GTID has been already implemented. But still the replication is using Binlog file name and position for replicating the data.</p><p>This is my slave status. You can see the GTID has been enabled but the <code class="language-html highlighter-rouge">Auto_Position</code> is still 0 which means still my replication is binlog filename and position. No issues with the replication. But the MySQL world already moved to GTID for better control on replication and Failover.</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>             Master_Server_Id: 10010
                  Master_UUID: c924545b-a3e3-11e8-8a39-42010a280410
             Master_Info_File: mysql.slave_master_info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: 
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: c924545b-a3e3-11e8-8a39-42010a280410:1021245412-5365162807
            Executed_Gtid_Set: c924545b-a3e3-11e8-8a39-42010a280410:4975917719-5053294256:5053294258-5365162769
                Auto_Position: 0
</code></pre></div></div><p>Im using MySQL Orchestrator for Failover. And we need to use either <code class="language-html highlighter-rouge">MySQL GTID</code> for <code class="language-html highlighter-rouge">pesudo GTID</code> for failover. I did googling for how can I change this auto position to 1 without breaking the replication. Initially I thought just get the last executed the GTID set from the slave status and purge it. Then change the auto position to 1. But it was a bad idea.</p><h3 id="why">WHY?</h3><p>I stopped the slave thread and got this last executed GTID from the slave status.</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>c924545b-a3e3-11e8-8a39-42010a280410:3501467-3659834
</code></pre></div></div><p>Then I ran,</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>set global gtid_purged='c924545b-a3e3-11e8-8a39-42010a280410:3501467-3659834'; 
</code></pre></div></div><p>So what happened here is, it only purges ID 3501467 and 3659834. Then if I start the slave thread, itâ€™ll get the below error message.</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>Got fatal error 1236 from master when reading data from binary log:  'The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the  master has purged binary logs containing GTIDs that the slave requires.'
</code></pre></div></div><p>MySQL tried to ignore the IDs But we want to purge all the Is till 3659834. Its not a big deal who all are familiar with GTID. It just a logical way thinking :)</p><p>Just try to purge the GTID set beginning from 1. Follow these steps to convert binlog position based to auto position.</p><blockquote><p><strong>DISCLAIMER</strong>: This command invokes <code class="language-html highlighter-rouge">RESET MASTER</code>. If you have any application or the slave is acting as a master for another slave(Cascading replication), then you will be fired from your organization. So make sure this is only a slave role and its binlog is not used for any streaming or other replication process.</p></blockquote><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>mysql&gt; stop slave;
Query OK, 0 rows affected (0.05 sec)
</code></pre></div></div><p>Get the binlog filename, position, GTID. So if something goes wrong we can resume the replication with binlog file name and position.</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>mysql&gt; show slave status\G;
            Master_Log_File: mysql-bin.012187
          Read_Master_Log_Pos: 450020919
               Relay_Log_File: mysqld-relay-bin.007983
                Relay_Log_Pos: 450002463
        Relay_Master_Log_File: mysql-bin.012187
             Slave_IO_Running: No
            Slave_SQL_Running: No
          Exec_Master_Log_Pos: 450002253
              Relay_Log_Space: 450021421
           Retrieved_Gtid_Set: c924545b-a3e3-11e8-8a39-42010a280410:1021245412-5365162807
            Executed_Gtid_Set: c924545b-a3e3-11e8-8a39-42010a280410:4975917719-5053294256:5053294258-5365162769
                Auto_Position: 0
</code></pre></div></div><p>Reset the master and enable the GTID.</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="syntax"><code>mysql&gt; SHOW GLOBAL VARIABLES LIKE 'gtid%';
+---------------+----------------------------------------------------------------------------------+
| Variable_name | Value                                                                            |
+---------------+----------------------------------------------------------------------------------+
| gtid_executed | c924545b-a3e3-11e8-8a39-42010a280410:4975917719-5053294256:5053294258-5365162769 |
| gtid_mode     | ON                                                                               |
| gtid_owned    |                                                                                  |
| gtid_purged   |                                                                                  |
+---------------+----------------------------------------------------------------------------------+
4 rows in set (0.00 sec)

mysql&gt; reset master;
Query OK, 0 rows affected (17.23 sec)

mysql&gt; set global gtid_purged='c924545b-a3e3-11e8-8a39-42010a280410:4975917719-5053294256:1-5365162769';
Query OK, 0 rows affected (0.06 sec)

mysql&gt; change master to master_auto_position=1;
Query OK, 0 rows affected (0.15 sec)

mysql&gt; start slave;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; show slave status\G
Executed_Gtid_Set: c924545b-a3e3-11e8-8a39-42010a280410:1-5365162769
Auto_Position: 1
</code></pre></div></div><span class="meta"><time datetime="2019-08-24T07:58:00+00:00">August 24, 2019</time> &middot; <a href="/tags/#mysql">mysql</a>, <a href="/tags/#replication">replication</a>, <a href="/tags/#gtid">gtid</a></span><hr> <!--<span class="meta"><time datetime="2019-08-24T07:58:00+00:00">August 24, 2019</time> &middot; <a class="post" href="/tag/mysql">mysql</a>, <a class="post" href="/tag/replication">replication</a>, <a class="post" href="/tag/gtid">gtid</a></span> --></section></main></body></html>
