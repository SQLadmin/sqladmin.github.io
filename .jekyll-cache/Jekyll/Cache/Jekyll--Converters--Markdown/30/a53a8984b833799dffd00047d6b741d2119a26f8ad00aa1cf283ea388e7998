I":Œ<p>RedShiftâ€™s system tables and views are haveing more depth information about the queries, Its highly important to export the RedShift system tables and views (STL tables) to S3 for persistent. These tables contains the information like query history, plan, query summary, etc. But these informations only available for very shot period of time. RedShift documentation says that from 2 days to 5 days we can retrive the data. Itâ€™ll automatically flush the older data to keep the disk space utilization under the control. This is fine for ad-hoc performance tuning but if you want to keep the complete history of the data from these system tables and views then we have to export/Unload them to S3. I did google for implementing this on my infra, I found 2 awesome links from official AWS blog and github repo. But I wanted to try something easy with cost benifical. So I have written a stored procedure to do this.</p>

<h2 id="exsiting-options">Exsiting Options:</h2>

<ul>
  <li><strong><a href="https://aws.amazon.com/blogs/big-data/how-to-retain-system-tables-data-spanning-multiple-amazon-redshift-clusters-and-run-cross-cluster-diagnostic-queries/">#1 Export via Glue</a></strong> - We have to spend money for Glue and DynamoDB. Lambda will be the trigger to export this.</li>
  <li><strong><a href="https://github.com/awslabs/amazon-redshift-utils/tree/master/src/SystemTablePersistence">#2 Export via Lambda</a></strong> - This is just a stright farword unload command, but this repo is having a lot of other utilities. If someone is new to Python, they might get stuck in understand this. But anyhow we only need the system table export option.</li>
  <li><strong>#3 Export via Stored Procedure</strong> - I decided to use stored procedures to do this. Few tables like <code class="language-html highlighter-rouge">stl_querytext</code> and <code class="language-html highlighter-rouge">stl_query_metrics</code> or not having any timestamp column, but we have to export them incrementally.</li>
</ul>

<h2 id="list-of-tables-and-views">List of tables and views:</h2>

<p>For now I have created this procedure to export only the following tables.</p>
<ol>
  <li>stl_query</li>
  <li>stl_dlltext</li>
  <li>stl_querytext</li>
  <li>stl_utilitytext</li>
  <li>stl_wlm_query</li>
  <li>stl_explain</li>
  <li>svl_query_summary</li>
  <li>stl_query_metrics</li>
  <li>stl_alert_event_log</li>
</ol>

<h2 id="incremental-approach">Incremental approach:</h2>

<p>From the above tables, 4 tables are having the timestamp column. So we can easily find the incremental data. 
First time itâ€™ll upload all of the rows and mark the maximum value for the timestamp into this history table. 
Next time itâ€™ll go and look at the max value of the timestamp column and export the incremental data.
The tables that doesnâ€™t have the timestamp column, we can join them on the <code class="language-html highlighter-rouge">userid</code>, <code class="language-html highlighter-rouge">query id</code>, <code class="language-html highlighter-rouge">pid</code>, <code class="language-html highlighter-rouge">xid</code> columns with <code class="language-html highlighter-rouge">stl_query</code> table. So we can get the incremetnal data.</p>

<h2 id="stored-procedure">Stored Procedure:</h2>

<p>The following items are hardcoded, you need to replace them.</p>
<ul>
  <li><strong>s3_path</strong> - s3://prod-bucket/log-testing</li>
  <li><strong>iam_role</strong> - arn:aws:iam::XXXXXXXXXX:role/Red-Shift-Access-S3</li>
  <li><strong>unload_options</strong> - ADDQUOTES ALLOWOVERWRITE HEADER</li>
  <li>
    <table>
      <tbody>
        <tr>
          <td><strong>delimiter</strong> -</td>
        </tr>
      </tbody>
    </table>
  </li>
</ul>

<blockquote>
  <p><strong>NOTE</strong>: <code class="language-html highlighter-rouge">stl_querytxt</code> and <code class="language-html highlighter-rouge">stl_ddltext</code> tables are having the new line charactors like <code class="language-html highlighter-rouge">\n</code> and <code class="language-html highlighter-rouge">\r</code>, so we have to replace them.</p>
</blockquote>

<h3 id="create-the-history-table">Create the history table:</h3>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">PUBLIC</span><span class="p">.</span><span class="n">history_sysobjects</span> 
  <span class="p">(</span> 
     <span class="n">id</span>               <span class="nb">INT</span> <span class="k">IDENTITY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> 
     <span class="n">export_timestamp</span> <span class="nb">TIMESTAMP</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span> 
     <span class="n">object_name</span>      <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> 
     <span class="n">start_time</span>       <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> 
     <span class="n">unload_query</span>     <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">65000</span><span class="p">)</span> 
  <span class="p">);</span> </code></pre></figure>

<h3 id="redshift-procedure">RedShift procedure:</h3>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">PROCEDURE</span> <span class="k">public</span><span class="p">.</span><span class="n">persist_sysobjects</span><span class="p">()</span>
<span class="k">LANGUAGE</span> <span class="n">plpgsql</span> <span class="k">AS</span>
<span class="err">$$</span>
<span class="k">DECLARE</span>
<span class="c1">-- Store the max Timestamp</span>
<span class="n">stlq_starttime</span> <span class="nb">timestamp</span><span class="p">;</span>
<span class="n">ddlt_starttime</span> <span class="nb">timestamp</span><span class="p">;</span>
<span class="n">utlt_starttime</span> <span class="nb">timestamp</span><span class="p">;</span>
<span class="n">wq_starttime</span> <span class="nb">timestamp</span><span class="p">;</span>

<span class="c1">-- S3 path and credentials</span>
<span class="n">s3_path</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
<span class="n">iam_role</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
<span class="n">unload_options</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="k">delimiter</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="n">un_year</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="n">un_month</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="n">un_day</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="c1">-- Declare queries as variable</span>
<span class="n">stl_query_unload</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">65000</span><span class="p">);</span>
<span class="n">stl_ddltext_unload</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">65000</span><span class="p">);</span>
<span class="n">stl_utilitytext_unload</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">65000</span><span class="p">);</span>
<span class="n">stl_querytext_unload</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">65000</span><span class="p">);</span>
<span class="n">stl_wlm_query_unload</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">65000</span><span class="p">);</span>
<span class="n">stl_explain_unload</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">65000</span><span class="p">);</span>
<span class="n">svl_query_summary_unload</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">65000</span><span class="p">);</span>
<span class="n">stl_query_metrics_unload</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">65000</span><span class="p">);</span>
<span class="n">stl_alert_event_log_unload</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">65000</span><span class="p">);</span>

<span class="k">BEGIN</span>

<span class="c1">-- Get the yyyy/mm/dd for paritions in S3</span>
<span class="k">select</span> <span class="n">to_char</span><span class="p">(</span><span class="n">GETDATE</span><span class="p">(),</span><span class="s1">'YYYY'</span><span class="p">)</span> <span class="k">into</span> <span class="n">un_year</span><span class="p">;</span>
<span class="k">select</span> <span class="n">to_char</span><span class="p">(</span><span class="n">GETDATE</span><span class="p">(),</span><span class="s1">'MM'</span><span class="p">)</span> <span class="k">into</span> <span class="n">un_month</span><span class="p">;</span>
<span class="k">select</span> <span class="n">to_char</span><span class="p">(</span><span class="n">GETDATE</span><span class="p">(),</span><span class="s1">'DD'</span><span class="p">)</span> <span class="k">into</span> <span class="n">un_day</span><span class="p">;</span>

<span class="c1">-- S3 Options</span>
<span class="n">s3_path</span><span class="p">:</span><span class="o">=</span><span class="s1">'s3://prod-bucket/log-testing'</span><span class="p">;</span>
<span class="n">iam_role</span><span class="p">:</span><span class="o">=</span><span class="s1">'arn:aws:iam::XXXXXXXXXX:role/Red-Shift-Access-S3'</span><span class="p">;</span>
<span class="n">unload_options</span><span class="p">:</span><span class="o">=</span><span class="s1">'ADDQUOTES ALLOWOVERWRITE HEADER'</span><span class="p">;</span>
<span class="k">delimiter</span><span class="p">:</span><span class="o">=</span><span class="s1">'|'</span><span class="p">;</span>

<span class="c1">-- Find the current max timestamp </span>
<span class="k">select</span> <span class="k">max</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span> <span class="k">from</span> <span class="n">stl_query</span> <span class="k">into</span> <span class="n">stlq_starttime</span><span class="p">;</span>
<span class="k">select</span> <span class="k">max</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span> <span class="k">from</span> <span class="n">stl_ddltext</span> <span class="k">into</span> <span class="n">ddlt_starttime</span><span class="p">;</span>
<span class="k">select</span> <span class="k">max</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span> <span class="k">from</span> <span class="n">stl_utilitytext</span> <span class="k">into</span> <span class="n">utlt_starttime</span><span class="p">;</span>
<span class="k">select</span> <span class="k">max</span><span class="p">(</span><span class="n">service_class_start_time</span><span class="p">)</span> <span class="k">from</span> <span class="n">stl_wlm_query</span> <span class="k">into</span> <span class="n">wq_starttime</span><span class="p">;</span>

<span class="c1">-- Start exporting the data</span>
<span class="n">RAISE</span> <span class="n">info</span> <span class="s1">'Starting to unload stl_query'</span><span class="p">;</span>
<span class="n">stl_query_unload</span><span class="o">=</span><span class="s1">'unload(</span><span class="se">\'</span><span class="s1">SELECT stlq.* FROM stl_query  stlq,   (SELECT NVL(MAX(start_time),</span><span class="se">\\''</span><span class="s1">1902-01-01</span><span class="se">\\''</span><span class="s1">::TIMESTAMP) AS max_starttime FROM public.history_sysobjects where object_name=</span><span class="se">\\''</span><span class="s1">stl_query</span><span class="se">\\''</span><span class="s1">) h WHERE stlq.starttime &gt; h.max_starttime</span><span class="se">\'</span><span class="s1">) to </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">s3_path</span><span class="o">||</span><span class="s1">'/stl_query/'</span><span class="o">||</span><span class="n">un_year</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_month</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_day</span><span class="o">||</span><span class="s1">'/stl_query_</span><span class="se">\'</span><span class="s1"> iam_role </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">iam_role</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1"> '</span><span class="o">||</span><span class="n">unload_options</span><span class="o">||</span><span class="s1">' delimiter </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="k">delimiter</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1">'</span><span class="p">;</span>

<span class="k">execute</span> <span class="n">stl_query_unload</span><span class="p">;</span>     
<span class="k">insert</span> <span class="k">into</span> <span class="k">public</span><span class="p">.</span><span class="n">history_sysobjects</span> <span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">start_time</span><span class="p">,</span><span class="n">unload_query</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'stl_query'</span><span class="p">,</span><span class="n">stlq_starttime</span><span class="p">,</span><span class="n">stl_query_unload</span><span class="p">);</span>

<span class="n">RAISE</span> <span class="n">info</span> <span class="s1">'Starting to unload stl_ddltext'</span><span class="p">;</span>
<span class="n">stl_ddltext_unload</span><span class="o">=</span><span class="s1">'unload(</span><span class="se">\'</span><span class="s1">SELECT ddlt.userid,ddlt.pid,ddlt.label,ddlt.starttime, ddlt.endtime,ddlt.sequence,replace(replace(ddlt.text,</span><span class="se">\\''\\\\\\\\</span><span class="s1">n</span><span class="se">\\''</span><span class="s1">,</span><span class="se">\\''\\''</span><span class="s1">),</span><span class="se">\\''\\\\\\\\</span><span class="s1">r</span><span class="se">\\''</span><span class="s1">,</span><span class="se">\\''\\''</span><span class="s1">) as text FROM stl_ddltext ddlt,   (SELECT NVL(MAX(start_time),</span><span class="se">\\''</span><span class="s1">1902-01-01</span><span class="se">\\''</span><span class="s1">::TIMESTAMP) AS max_starttime FROM public.history_sysobjects where object_name=</span><span class="se">\\''</span><span class="s1">stl_ddltext</span><span class="se">\\''</span><span class="s1">) h WHERE ddlt.starttime &gt; h.max_starttime</span><span class="se">\'</span><span class="s1">) to </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">s3_path</span><span class="o">||</span><span class="s1">'/stl_ddltext/'</span><span class="o">||</span><span class="n">un_year</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_month</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_day</span><span class="o">||</span><span class="s1">'/stl_ddltext_</span><span class="se">\'</span><span class="s1"> iam_role </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">iam_role</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1"> '</span><span class="o">||</span><span class="n">unload_options</span><span class="o">||</span><span class="s1">' delimiter </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="k">delimiter</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1">'</span><span class="p">;</span>

<span class="k">execute</span> <span class="n">stl_ddltext_unload</span><span class="p">;</span>     
<span class="k">insert</span> <span class="k">into</span> <span class="k">public</span><span class="p">.</span><span class="n">history_sysobjects</span> <span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">start_time</span><span class="p">,</span><span class="n">unload_query</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'stl_ddltext'</span><span class="p">,</span><span class="n">ddlt_starttime</span><span class="p">,</span><span class="n">stl_ddltext_unload</span><span class="p">);</span>

<span class="n">RAISE</span> <span class="n">info</span> <span class="s1">'Starting to unload stl_utilitytext'</span><span class="p">;</span>
<span class="n">stl_utilitytext_unload</span><span class="o">=</span><span class="s1">'unload(</span><span class="se">\'</span><span class="s1">SELECT utlt.* FROM stl_utilitytext utlt, (SELECT NVL(MAX(start_time),</span><span class="se">\\''</span><span class="s1">1902-01-01</span><span class="se">\\''</span><span class="s1">::TIMESTAMP) AS max_starttime FROM public.history_sysobjects where object_name=</span><span class="se">\\''</span><span class="s1">stl_utilitytext</span><span class="se">\\''</span><span class="s1">) h WHERE utlt.starttime &gt; h.max_starttime</span><span class="se">\'</span><span class="s1">) to </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">s3_path</span><span class="o">||</span><span class="s1">'/stl_utilitytext/'</span><span class="o">||</span><span class="n">un_year</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_month</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_day</span><span class="o">||</span><span class="s1">'/stl_utilitytext_</span><span class="se">\'</span><span class="s1"> iam_role </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">iam_role</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1"> '</span><span class="o">||</span><span class="n">unload_options</span><span class="o">||</span><span class="s1">' delimiter </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="k">delimiter</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1">'</span><span class="p">;</span>

<span class="k">execute</span> <span class="n">stl_utilitytext_unload</span><span class="p">;</span>     
<span class="k">insert</span> <span class="k">into</span> <span class="k">public</span><span class="p">.</span><span class="n">history_sysobjects</span> <span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">start_time</span><span class="p">,</span><span class="n">unload_query</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'stl_utilitytext'</span><span class="p">,</span><span class="n">utlt_starttime</span><span class="p">,</span><span class="n">stl_utilitytext_unload</span><span class="p">);</span>

<span class="n">RAISE</span> <span class="n">info</span> <span class="s1">'Starting to unload stl_querytext'</span><span class="p">;</span>
<span class="n">stl_querytext_unload</span><span class="o">=</span><span class="s1">'unload(</span><span class="se">\'</span><span class="s1">select qtxt.userid,qtxt.xid,qtxt.pid,qtxt.query,qtxt.sequence,replace(replace(qtxt.text,</span><span class="se">\\''\\\\\\\\</span><span class="s1">n</span><span class="se">\\''</span><span class="s1">,</span><span class="se">\\''\\''</span><span class="s1">),</span><span class="se">\\''\\\\\\\\</span><span class="s1">r</span><span class="se">\\''</span><span class="s1">,</span><span class="se">\\''\\''</span><span class="s1">) as text from stl_querytext qtxt join stl_query qt on qt.userid=qtxt.userid and qt.query=qtxt.query and qt.xid=qtxt.xid and qt.pid=qtxt.pid where qt.starttime&gt;(SELECT NVL(MAX(start_time),</span><span class="se">\\''</span><span class="s1">1902-01-01</span><span class="se">\\''</span><span class="s1">::TIMESTAMP) AS max_starttime FROM public.history_sysobjects where object_name=</span><span class="se">\\''</span><span class="s1">stl_query</span><span class="se">\\''</span><span class="s1">)</span><span class="se">\'</span><span class="s1">) to </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">s3_path</span><span class="o">||</span><span class="s1">'/stl_querytext/'</span><span class="o">||</span><span class="n">un_year</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_month</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_day</span><span class="o">||</span><span class="s1">'/stl_querytext_</span><span class="se">\'</span><span class="s1"> iam_role </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">iam_role</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1"> '</span><span class="o">||</span><span class="n">unload_options</span><span class="o">||</span><span class="s1">' delimiter </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="k">delimiter</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1">'</span><span class="p">;</span>

<span class="k">execute</span> <span class="n">stl_querytext_unload</span><span class="p">;</span>     
<span class="k">insert</span> <span class="k">into</span> <span class="k">public</span><span class="p">.</span><span class="n">history_sysobjects</span> <span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">unload_query</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'stl_querytext'</span><span class="p">,</span><span class="n">stl_querytext_unload</span><span class="p">);</span>

<span class="n">RAISE</span> <span class="n">info</span> <span class="s1">'Starting to unload stl_wlm_query'</span><span class="p">;</span>
<span class="n">stl_wlm_query_unload</span><span class="o">=</span><span class="s1">'unload(</span><span class="se">\'</span><span class="s1">SELECT wq.* FROM stl_wlm_query wq, (SELECT NVL(MAX(start_time),</span><span class="se">\\''</span><span class="s1">1902-01-01</span><span class="se">\\''</span><span class="s1">::TIMESTAMP) AS max_service_class_start_time FROM public.history_sysobjects where object_name=</span><span class="se">\\''</span><span class="s1">stl_wlm_query</span><span class="se">\\''</span><span class="s1">) h WHERE wq.service_class_start_time &gt; h.max_service_class_start_time</span><span class="se">\'</span><span class="s1">) to </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">s3_path</span><span class="o">||</span><span class="s1">'/stl_wlm_query/'</span><span class="o">||</span><span class="n">un_year</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_month</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_day</span><span class="o">||</span><span class="s1">'/stl_wlm_query_</span><span class="se">\'</span><span class="s1"> iam_role </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">iam_role</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1"> '</span><span class="o">||</span><span class="n">unload_options</span><span class="o">||</span><span class="s1">' delimiter </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="k">delimiter</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1">'</span><span class="p">;</span>

<span class="k">execute</span> <span class="n">stl_wlm_query_unload</span><span class="p">;</span>     
<span class="k">insert</span> <span class="k">into</span> <span class="k">public</span><span class="p">.</span><span class="n">history_sysobjects</span> <span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">start_time</span><span class="p">,</span><span class="n">unload_query</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'stl_wlm_query'</span><span class="p">,</span><span class="n">stlq_starttime</span><span class="p">,</span><span class="n">stl_wlm_query_unload</span><span class="p">);</span>

<span class="n">RAISE</span> <span class="n">info</span> <span class="s1">'Starting to unload stl_explain'</span><span class="p">;</span>
<span class="n">stl_explain_unload</span><span class="o">=</span><span class="s1">'unload(</span><span class="se">\'</span><span class="s1">select exp.* from stl_explain exp join stl_query stlq on stlq.userid=exp.userid and stlq.query=exp.query where stlq.starttime&gt;(SELECT NVL(MAX(start_time),</span><span class="se">\\''</span><span class="s1">1902-01-01</span><span class="se">\\''</span><span class="s1">::TIMESTAMP) AS max_starttime FROM public.history_sysobjects where object_name=</span><span class="se">\\''</span><span class="s1">stl_query</span><span class="se">\\''</span><span class="s1">)</span><span class="se">\'</span><span class="s1">) to </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">s3_path</span><span class="o">||</span><span class="s1">'/stl_explain/'</span><span class="o">||</span><span class="n">un_year</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_month</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_day</span><span class="o">||</span><span class="s1">'/stl_explain_</span><span class="se">\'</span><span class="s1"> iam_role </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">iam_role</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1"> '</span><span class="o">||</span><span class="n">unload_options</span><span class="o">||</span><span class="s1">' delimiter </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="k">delimiter</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1">'</span><span class="p">;</span>

<span class="k">execute</span> <span class="n">stl_explain_unload</span><span class="p">;</span>     
<span class="k">insert</span> <span class="k">into</span> <span class="k">public</span><span class="p">.</span><span class="n">history_sysobjects</span> <span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">unload_query</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'stl_explain'</span><span class="p">,</span><span class="n">stl_explain_unload</span><span class="p">);</span>

<span class="n">RAISE</span> <span class="n">info</span> <span class="s1">'Starting to unload svl_query_summary'</span><span class="p">;</span>
<span class="n">svl_query_summary_unload</span><span class="o">=</span><span class="s1">'unload(</span><span class="se">\'</span><span class="s1">select qs.* from svl_query_summary qs join stl_query stlq on stlq.userid=qs.userid and stlq.query=qs.query  where stlq.starttime&gt;(SELECT NVL(MAX(start_time),</span><span class="se">\\''</span><span class="s1">1902-01-01</span><span class="se">\\''</span><span class="s1">::TIMESTAMP) AS max_starttime FROM public.history_sysobjects where object_name=</span><span class="se">\\''</span><span class="s1">stl_query</span><span class="se">\\''</span><span class="s1">)</span><span class="se">\'</span><span class="s1">)  to </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">s3_path</span><span class="o">||</span><span class="s1">'/svl_query_summary/'</span><span class="o">||</span><span class="n">un_year</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_month</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_day</span><span class="o">||</span><span class="s1">'/svl_query_summary_</span><span class="se">\'</span><span class="s1"> iam_role </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">iam_role</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1"> '</span><span class="o">||</span><span class="n">unload_options</span><span class="o">||</span><span class="s1">' delimiter </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="k">delimiter</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1">'</span><span class="p">;</span>

<span class="k">execute</span> <span class="n">svl_query_summary_unload</span><span class="p">;</span>     
<span class="k">insert</span> <span class="k">into</span> <span class="k">public</span><span class="p">.</span><span class="n">history_sysobjects</span> <span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">unload_query</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'svl_query_summary'</span><span class="p">,</span><span class="n">svl_query_summary_unload</span><span class="p">);</span>


<span class="n">RAISE</span> <span class="n">info</span> <span class="s1">'Starting to unload stl_query_metrics'</span><span class="p">;</span>
<span class="n">stl_query_metrics_unload</span><span class="o">=</span><span class="s1">'unload(</span><span class="se">\'</span><span class="s1">select qm.* from stl_query_metrics qm join stl_query stlq on stlq.userid=qm.userid and stlq.query=qm.query  where stlq.starttime&gt;(SELECT NVL(MAX(start_time),</span><span class="se">\\''</span><span class="s1">1902-01-01</span><span class="se">\\''</span><span class="s1">::TIMESTAMP) AS max_starttime FROM public.history_sysobjects where object_name=</span><span class="se">\\''</span><span class="s1">stl_query</span><span class="se">\\''</span><span class="s1">)</span><span class="se">\'</span><span class="s1">) to </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">s3_path</span><span class="o">||</span><span class="s1">'/stl_query_metrics/'</span><span class="o">||</span><span class="n">un_year</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_month</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_day</span><span class="o">||</span><span class="s1">'/stl_query_metrics_</span><span class="se">\'</span><span class="s1"> iam_role </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">iam_role</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1"> '</span><span class="o">||</span><span class="n">unload_options</span><span class="o">||</span><span class="s1">' delimiter </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="k">delimiter</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1">'</span><span class="p">;</span>

<span class="k">execute</span> <span class="n">stl_query_metrics_unload</span><span class="p">;</span>     
<span class="k">insert</span> <span class="k">into</span> <span class="k">public</span><span class="p">.</span><span class="n">history_sysobjects</span> <span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">unload_query</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'stl_query_metrics'</span><span class="p">,</span><span class="n">stl_query_metrics_unload</span><span class="p">);</span>

<span class="n">RAISE</span> <span class="n">info</span> <span class="s1">'Starting to unload stl_alert_event_log'</span><span class="p">;</span>
<span class="n">stl_alert_event_log_unload</span><span class="o">=</span><span class="s1">'unload(</span><span class="se">\'</span><span class="s1">select evnt.* from stl_alert_event_log evnt join stl_query qt on qt.userid=evnt.userid and qt.query=evnt.query and qt.xid=evnt.xid and qt.pid=evnt.pid  where qt.starttime&gt;(SELECT NVL(MAX(start_time),</span><span class="se">\\''</span><span class="s1">1902-01-01</span><span class="se">\\''</span><span class="s1">::TIMESTAMP) AS max_starttime FROM public.history_sysobjects where object_name=</span><span class="se">\\''</span><span class="s1">stl_query</span><span class="se">\\''</span><span class="s1">)</span><span class="se">\'</span><span class="s1">) to </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">s3_path</span><span class="o">||</span><span class="s1">'/stl_alert_event_log/'</span><span class="o">||</span><span class="n">un_year</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_month</span><span class="o">||</span><span class="s1">'/'</span><span class="o">||</span><span class="n">un_day</span><span class="o">||</span><span class="s1">'/stl_alert_event_log_</span><span class="se">\'</span><span class="s1"> iam_role </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="n">iam_role</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1"> '</span><span class="o">||</span><span class="n">unload_options</span><span class="o">||</span><span class="s1">' delimiter </span><span class="se">\'</span><span class="s1">'</span><span class="o">||</span><span class="k">delimiter</span><span class="o">||</span><span class="s1">'</span><span class="se">\'</span><span class="s1">'</span><span class="p">;</span>

<span class="k">execute</span> <span class="n">stl_alert_event_log_unload</span><span class="p">;</span>     
<span class="k">insert</span> <span class="k">into</span> <span class="k">public</span><span class="p">.</span><span class="n">history_sysobjects</span> <span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">unload_query</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'stl_alert_event_log'</span><span class="p">,</span><span class="n">stl_alert_event_log_unload</span><span class="p">);</span>

<span class="k">END</span>
<span class="err">$$</span><span class="p">;</span> </code></pre></figure>

:ET